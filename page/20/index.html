<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon.ico?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="优秀是一种习惯">
<meta name="keywords" content="Python Java">
<meta property="og:type" content="website">
<meta property="og:title" content="徐先生的技术栈">
<meta property="og:url" content="https://dirsky.github.io/page/20/index.html">
<meta property="og:site_name" content="徐先生的技术栈">
<meta property="og:description" content="优秀是一种习惯">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="徐先生的技术栈">
<meta name="twitter:description" content="优秀是一种习惯">
  <link rel="canonical" href="https://dirsky.github.io/page/20/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>徐先生的技术栈</title>
  <meta name="generator" content="Hexo 3.9.0">
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2acd2bc9d0bd256dbd6679268f609dbd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container">
    <div class="headband"></div>

<a href="https://github.com/dirsky" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">徐先生的技术栈</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">生来为创造价值</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="https://dirsky.github.io/2016/03/17/lang-java-What-s-New-in-JDK8-JDK8新特性总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frank">
      <meta itemprop="description" content="优秀是一种习惯">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="徐先生的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/03/17/lang-java-What-s-New-in-JDK8-JDK8新特性总结/" class="post-title-link" itemprop="url">JDK8新特性总结</a>
          
        </h1>

        <div class="post-meta">

		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2016-03-17 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-17T00:00:00+08:00">2016-03-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-09 10:00:27" itemprop="dateModified" datetime="2021-08-09T10:00:27+08:00">2021-08-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lang/" itemprop="url" rel="index"><span itemprop="name">lang</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2016/03/17/lang-java-What-s-New-in-JDK8-JDK8新特性总结/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2016/03/17/lang-java-What-s-New-in-JDK8-JDK8新特性总结/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>16k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>15 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>总结了部分JDK8新特性，另外一些新特性可以通过Oracle的官方文档查看，毕竟是官方文档，各种新特性都会介绍，有兴趣的可以去看。<br></p>
<h2 id="Oracle官方文档-What’s-New-in-JDK8"><a href="#Oracle官方文档-What’s-New-in-JDK8" class="headerlink" title="Oracle官方文档:What’s New in JDK8"></a><a href="https://www.oracle.com/technetwork/java/javase/8-whats-new-2157071.html" target="_blank" rel="noopener">Oracle官方文档:What’s New in JDK8</a></h2><ul>
<li><p><a href="#JavaProgrammingLanguage">Java语言特性</a></p>
<ul>
<li><p><a href="#LambdaExpressions">Lambda表达式是一个新的语言特性，已经在JDK8中加入。它是一个可以传递的代码块，你也可以把它们当做方法参数。<br>Lambda表达式允许您更紧凑地创建单虚方法接口（称为功能接口）的实例。</a></p>
</li>
<li><p><a href="#MethodReferences">方法引用为已经存在的具名方法提供易于阅读的Lambda表达式</a></p>
</li>
<li><p><a href="#DefaultMethods">默认方法允许将新功能添加到库的接口，并确保与为这些接口的旧版本编写的代码的二进制兼容性。</a></p>
</li>
<li><p><a href="#ImprovedTypeInference">改进的类型推断。</a></p>
</li>
<li><p><a href="#MethodParameterReflection">方法参数反射(通过反射获得方法参数信息)</a>  </p>
</li>
</ul>
</li>
<li><p><a href="#stream">流(stream)</a></p>
<ul>
<li><a href>新java.util.stream包中的类提供Stream API以支持对元素流的功能样式操作。流(stream)和I/O里的流不是同一个概念<br> ，使用stream API可以更方便的操作集合。</a></li>
</ul>
</li>
<li><p><a href>国际化</a></p>
<ul>
<li>待办</li>
</ul>
</li>
<li><p>待办</p>
</li>
</ul>
<hr>
<!-- ---------------------------------------------------Lambda表达式-------------------------------------------------------- -->
<!-- 标题与跳转-->
<p><span id="JavaProgrammingLanguage"></span><br><span id="LambdaExpressions"></span></p>
<!-- 标题与跳转结束-->
<!-- 正文-->

<h2 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="　　　　　　　　　　　　　Lambda表达式"></a>　　　　　　　　　　　　　Lambda表达式</h2><h3 id="1-什么是Lambda表达式"><a href="#1-什么是Lambda表达式" class="headerlink" title="1.什么是Lambda表达式"></a>1.什么是Lambda表达式</h3><p><strong>Lambda表达式实质上是一个可传递的代码块，Lambda又称为闭包或者匿名函数，是函数式编程语法，让方法可以像普通参数一样传递</strong></p>
<h3 id="2-Lambda表达式语法"><a href="#2-Lambda表达式语法" class="headerlink" title="2.Lambda表达式语法"></a>2.Lambda表达式语法</h3><figure class="highlight plain"><figcaption><span>-> &#123;执行代码块&#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;br&gt;参数列表可以为空```()-&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><br>可以加类型声明比如<figure class="highlight plain"><figcaption><span>para1, int para2) -> &#123;return para1 + para2;&#125;```我们可以看到，lambda同样可以有返回值.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;br&gt;在编译器可以推断出类型的时候，可以将类型声明省略，比如```(para1, para2) -&gt; &#123;return para1 + para2;&#125;</span><br></pre></td></tr></table></figure></p>
<p><br>(lambda有点像动态类型语言语法。lambda在字节码层面是用invokedynamic实现的，而这条指令就是为了让JVM更好的支持运行在其上的动态类型语言)</p>
<h3 id="3-函数式接口"><a href="#3-函数式接口" class="headerlink" title="3.函数式接口"></a>3.函数式接口</h3><p>在了解Lambda表达式之前，有必要先了解什么是函数式接口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">**函数式接口指的是有且只有一个抽象(abstract)方法的接口**&lt;br&gt;</span><br><span class="line">当需要一个函数式接口的对象时，就可以用Lambda表达式来实现，举个常用的例子:</span><br><span class="line">&lt;br&gt;</span><br><span class="line">```java</span><br><span class="line">  Thread thread = new Thread(() -&gt; &#123;</span><br><span class="line">      System.out.println(&quot;This is JDK8&apos;s Lambda!&quot;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></p>
<p>这段代码和函数式接口有啥关系？我们回忆一下，Thread类的构造函数里是不是有一个以Runnable接口为参数的？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">(Runnable target)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runnable Interface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里大家可能已经明白了，<strong>Lambda表达式相当于一个匿名类或者说是一个匿名方法</strong>。上面Thread的例子相当于</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Anonymous class"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>也就是说，上面的lambda表达式相当于实现了这个run()方法，然后当做参数传入(个人感觉可以这么理解,lambda表达式就是一个函数，只不过它的返回值、参数列表都<br>由编译器帮我们推断，因此可以减少很多代码量)。<br><br>Lambda也可以这样用 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runnable runnable = () -&gt; &#123;...&#125;;</span><br></pre></td></tr></table></figure>

<p>其实这和上面的用法没有什么本质上的区别。<br><br>至此大家应该明白什么是函数式接口以及函数式接口和lambda表达式之间的关系了。在JDK8中修改了接口的规范，<br>目的是为了在给接口添加新的功能时保持向前兼容(个人理解)，比如一个已经定义了的函数式接口，某天我们想给它添加新功能，那么就不能保持向前兼容了，<br>因为在旧的接口规范下，添加新功能必定会破坏这个函数式接口<a href>(JDK8中接口规范)</a><br><br><br>除了上面说的Runnable接口之外，JDK中已经存在了很多函数式接口<br>比如(当然不止这些):</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- ```java.util.Comparator</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;br&gt;**关于JDK中的预定义的函数式接口**</span><br><span class="line"></span><br><span class="line">- JDK在```java.util.function```下预定义了很多函数式接口</span><br><span class="line">  - ```Function&lt;T, R&gt; &#123;R apply(T t);&#125;``` 接受一个T对象，然后返回一个R对象，就像普通的函数。</span><br><span class="line">  - ```Consumer&lt;T&gt; &#123;void accept(T t);&#125;``` 消费者 接受一个T对象，没有返回值。</span><br><span class="line">  - ```Predicate&lt;T&gt; &#123;boolean test(T t);&#125;``` 判断，接受一个T对象，返回一个布尔值。</span><br><span class="line">  - ```Supplier&lt;T&gt; &#123;T get();&#125; 提供者(工厂)``` 返回一个T对象。</span><br><span class="line">  - 其他的跟上面的相似，大家可以看一下function包下的具体接口。</span><br><span class="line">### 4.变量作用域</span><br><span class="line">```java</span><br><span class="line">public class VaraibleHide &#123;</span><br><span class="line">    @FunctionalInterface</span><br><span class="line">    interface IInner &#123;</span><br><span class="line">        void printInt(int x);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int x = 20;</span><br><span class="line">        IInner inner = new IInner() &#123;</span><br><span class="line">            int x = 10;</span><br><span class="line">            @Override</span><br><span class="line">            public void printInt(int x) &#123;</span><br><span class="line">                System.out.println(x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        inner.printInt(30);</span><br><span class="line">        </span><br><span class="line">        inner = (s) -&gt; &#123;</span><br><span class="line">            //Variable used in lambda expression should be final or effectively final</span><br><span class="line">            //!int x = 10;</span><br><span class="line">            //!x= 50; error</span><br><span class="line">            System.out.print(x);</span><br><span class="line">        &#125;;</span><br><span class="line">        inner.printInt(30);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出 :</span><br><span class="line">30</span><br><span class="line">20</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>对于lambda表达式<figure class="highlight java"><figcaption><span>inner </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">的参数列表()获取的变量成为自由变量，它是被lambda表达式捕获的。</span><br><span class="line">&lt;br&gt;lambda表达式和内部类一样，对外部自由变量捕获时，外部自由变量必须为<span class="keyword">final</span>或者是最终变量(effectively <span class="keyword">final</span>)的，也就是说这个变量初始化后就不能为它赋新值，同时lambda不像内部类/匿名类，lambda表达式与外围嵌套块有着相同的作用域，因此对变量命名的有关规则对lambda同样适用。大家阅读上面的代码对这些概念应该不难理解。</span><br><span class="line">&lt;span id="MethodReferences"&gt;&lt;/span&gt;</span><br><span class="line">### 5.方法引用</span><br><span class="line">**只需要提供方法的名字，具体的调用过程由Lambda和函数式接口来确定，这样的方法调用成为方法引用。**</span><br><span class="line">&lt;br&gt;下面的例子会打印list中的每个元素:</span><br><span class="line">```java</span><br><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(System.out::println);</span><br></pre></td></tr></table></figure></p>
<p>其中<figure class="highlight plain"><figcaption><span>```(para)->&#123;System.out.println(para);&#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;br&gt;我们看一下List#forEach方法 ```default void forEach(Consumer&lt;? super T&gt; action)```可以看到它的参数是一个Consumer接口，该接口是一个函数式接口</span><br><span class="line">```java</span><br><span class="line">@FunctionalInterface</span><br><span class="line">public interface Consumer&lt;T&gt; &#123;</span><br><span class="line">    void accept(T t);</span><br></pre></td></tr></table></figure></p>
<p>大家能发现这个函数接口的方法和<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;br&gt;我们自己定义一个方法，看看能不能像标准输出的打印函数一样被调用</span><br><span class="line">```java</span><br><span class="line">public class MethodReference &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(MethodReference::myPrint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void myPrint(int i) &#123;</span><br><span class="line">        System.out.print(i + &quot;, &quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,</span><br></pre></td></tr></table></figure></p>
<p>可以看到，我们自己定义的方法也可以当做方法引用。<br><br>到这里大家多少对方法引用有了一定的了解，我们再来说一下方法引用的形式。</p>
<ul>
<li>方法引用<ul>
<li>类名::静态方法名</li>
<li>类名::实例方法名</li>
<li>类名::new (构造方法引用)</li>
<li>实例名::实例方法名<br>可以看出，方法引用是通过(方法归属名)::(方法名)来调用的。通过上面的例子已经讲解了一个<code>类名::静态方法名</code>的使用方法了，下面再依次介绍其余的几种<br>方法引用的使用方法。<br></li>
</ul>
</li>
</ul>
<p><strong>类名::实例方法名</strong><br><br>先来看一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] strings = <span class="keyword">new</span> String[<span class="number">10</span>];</span><br><span class="line">Arrays.sort(strings, String::compareToIgnoreCase);</span><br></pre></td></tr></table></figure>

<p><strong>上面的String::compareToIgnoreCase等价于(x, y) -&gt; {return x.compareToIgnoreCase(y);}</strong><br><br>我们看一下<code>Arrays#sort</code>方法<code>public static &lt;T&gt; void sort(T[] a, Comparator&lt;? super T&gt; c)</code>,<br>可以看到第二个参数是一个Comparator接口，该接口也是一个函数式接口，其中的抽象方法是<code>int compare(T o1, T o2);</code>，再看一下<br><code>String#compareToIgnoreCase</code>方法,<code>public int compareToIgnoreCase(String str)</code>，这个方法好像和上面讲方法引用中<code>类名::静态方法名</code>不大一样啊，它<br>的参数列表和函数式接口的参数列表不一样啊，虽然它的返回值一样？<br><br>是的，确实不一样但是别忘了，String类的这个方法是个实例方法，而不是静态方法，也就是说，这个方法是需要有一个接收者的。所谓接收者就是<br>instance.method(x)中的instance，<br>它是某个类的实例，有的朋友可能已经明白了。上面函数式接口的<code>compare(T o1, T o2)</code>中的第一个参数作为了实例方法的接收者，而第二个参数作为了实例方法的<br>参数。我们再举一个自己实现的例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodReference</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MethodReference[] methodReferences = <span class="keyword">new</span> MethodReference[<span class="number">10</span>];</span><br><span class="line">        Arrays.sort(methodReferences, MethodReference::myCompare);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">myCompare</span><span class="params">(MethodReference o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的例子可以在IDE里通过编译，大家有兴趣的可以模仿上面的例子自己写一个程序，打印出排序后的结果。<br><br><strong>构造器引用</strong><br><br>构造器引用仍然需要与特定的函数式接口配合使用，并不能像下面这样直接使用。IDE会提示String不是一个函数式接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compile error : String is not a functional interface</span></span><br><span class="line">String str = String::<span class="keyword">new</span>;</span><br></pre></td></tr></table></figure>

<p>下面是一个使用构造器引用的例子，可以看出构造器引用可以和这种工厂型的函数式接口一起使用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">IFunctional</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">func</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstructorReference</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstructorReference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Supplier&lt;ConstructorReference&gt; supplier0 = () -&gt; <span class="keyword">new</span> ConstructorReference();</span><br><span class="line">        Supplier&lt;ConstructorReference&gt; supplier1 = ConstructorReference::<span class="keyword">new</span>;</span><br><span class="line">        IFunctional&lt;ConstructorReference&gt; functional = () -&gt; <span class="keyword">new</span> ConstructorReference();</span><br><span class="line">        IFunctional&lt;ConstructorReference&gt; functional1 = ConstructorReference::<span class="keyword">new</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是一个JDK官方的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T, SOURCE extends Collection&lt;T&gt;, DEST extends Collection&lt;T&gt;&gt;</span><br><span class="line">  <span class="function">DEST <span class="title">transferElements</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      SOURCE sourceCollection,</span></span></span><br><span class="line"><span class="function"><span class="params">      Supplier&lt;DEST&gt; collectionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      DEST result = collectionFactory.get();</span><br><span class="line">      <span class="keyword">for</span> (T t : sourceCollection) &#123;</span><br><span class="line">          result.add(t);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  Set&lt;Person&gt; rosterSet = transferElements(</span><br><span class="line">          roster, HashSet::<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure>

<p><strong>实例::实例方法</strong><br><br><br>其实开始那个例子就是一个实例::实例方法的引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>其中System.out就是一个实例，println是一个实例方法。相信不用再给大家做解释了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Lambda表达式是JDK8引入Java的函数式编程语法，使用Lambda需要直接或者间接的与函数式接口配合，在开发中使用Lambda可以减少代码量，<br>但是并不是说必须要使用Lambda(虽然它是一个很酷的东西)。有些情况下使用Lambda会使代码的可读性急剧下降，并且也节省不了多少代码，<br>所以在实际开发中还是需要仔细斟酌是否要使用Lambda。和Lambda相似的还有JDK10中加入的var类型推断，同样对于这个特性需要斟酌使用。</p>
<!-- ---------------------------------------------------Lambda表达式结束---------------------------------------------------- -->
<hr>
<!-- ---------------------------------------------------接口默认方法-------------------------------------------------------- -->
<p><span id="DefaultMethods"></span></p>
<h2 id="JDK8接口规范"><a href="#JDK8接口规范" class="headerlink" title="　　　　　　　　　　　　　JDK8接口规范"></a>　　　　　　　　　　　　　JDK8接口规范</h2><h3 id="在JDK8中引入了lambda表达式，出现了函数式接口的概念，为了在扩展接口时保持向前兼容性-JDK8之前扩展接口会使得实现了该接口的类必须实现添加的方法，否则会报错。为了保持兼容性而做出妥协的特性还有泛型，泛型也是为了保持兼容性而失去了在一些别的语言泛型拥有的功能-，Java接口规范发生了一些改变。"><a href="#在JDK8中引入了lambda表达式，出现了函数式接口的概念，为了在扩展接口时保持向前兼容性-JDK8之前扩展接口会使得实现了该接口的类必须实现添加的方法，否则会报错。为了保持兼容性而做出妥协的特性还有泛型，泛型也是为了保持兼容性而失去了在一些别的语言泛型拥有的功能-，Java接口规范发生了一些改变。" class="headerlink" title="在JDK8中引入了lambda表达式，出现了函数式接口的概念，为了在扩展接口时保持向前兼容性(JDK8之前扩展接口会使得实现了该接口的类必须实现添加的方法，否则会报错。为了保持兼容性而做出妥协的特性还有泛型，泛型也是为了保持兼容性而失去了在一些别的语言泛型拥有的功能)，Java接口规范发生了一些改变。"></a>在JDK8中引入了lambda表达式，出现了函数式接口的概念，为了在扩展接口时保持向前兼容性(JDK8之前扩展接口会使得实现了该接口的类必须实现添加的方法，否则会报错。为了保持兼容性而做出妥协的特性还有泛型，泛型也是为了保持兼容性而失去了在一些别的语言泛型拥有的功能)，Java接口规范发生了一些改变。</h3><h3 id="1-JDK8以前的接口规范"><a href="#1-JDK8以前的接口规范" class="headerlink" title="1.JDK8以前的接口规范"></a>1.JDK8以前的接口规范</h3><ul>
<li>JDK8以前接口可以定义的变量和方法<ul>
<li>所有变量(Field)不论是否<i>显式</i> 的声明为<figure class="highlight plain"><figcaption><span>static final```，它实际上都是```public static final```的。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   - 所有方法(Method)不论是否&lt;i&gt;显示&lt;/i&gt; 的声明为```public abstract```，它实际上都是```public abstract```的。</span><br><span class="line">```java</span><br><span class="line">public interface AInterfaceBeforeJDK8 &#123;</span><br><span class="line">    int FIELD = 0;</span><br><span class="line">    void simpleMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>以上接口信息反编译以后可以看到字节码信息里Filed是public static final的，而方法是public abstract的，即是你没有显示的去声明它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIELD;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: (<span class="number">0x0019</span>) ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: <span class="keyword">int</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">simpleMethod</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: (<span class="number">0x0401</span>) ACC_PUBLIC, ACC_ABSTRACT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-JDK8之后的接口规范"><a href="#2-JDK8之后的接口规范" class="headerlink" title="2.JDK8之后的接口规范"></a>2.JDK8之后的接口规范</h3><ul>
<li>JDK8之后接口可以定义的变量和方法<ul>
<li>变量(Field)仍然必须是 <figure class="highlight java"><figcaption><span>public static final```的</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  - 方法(Method)除了可以是<span class="keyword">public</span> <span class="keyword">abstract</span>之外，还可以是<span class="keyword">public</span> <span class="keyword">static</span>或者是<span class="keyword">default</span>(相当于仅<span class="keyword">public</span>修饰的实例方法)的。</span><br><span class="line">从以上改变不难看出，修改接口的规范主要是为了能在扩展接口时保持向前兼容。</span><br><span class="line">&lt;br&gt;下面是一个JDK8之后的接口例子</span><br><span class="line">```java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AInterfaceInJDK8</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> simpleFiled = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> staticField = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticMethod</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">defaultMethod</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">simpleMethod</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>进行反编译(去除了一些没用信息)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> simpleFiled;</span><br><span class="line">    flags: (<span class="number">0x0019</span>) ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> staticField;</span><br><span class="line">    flags: (<span class="number">0x0019</span>) ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    flags: (<span class="number">0x0009</span>) ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticMethod</span><span class="params">()</span></span>;</span><br><span class="line">    flags: (<span class="number">0x0009</span>) ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defaultMethod</span><span class="params">()</span></span>;</span><br><span class="line">    flags: (<span class="number">0x0001</span>) ACC_PUBLIC</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">simpleMethod</span><span class="params">()</span> <span class="keyword">throws</span> java.io.IOException</span>;</span><br><span class="line">    flags: (<span class="number">0x0401</span>) ACC_PUBLIC, ACC_ABSTRACT</span><br><span class="line">    Exceptions:</span><br><span class="line">      <span class="keyword">throws</span> java.io.IOException</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 default关键字修饰的方法是像实例方法(就是普通类中定义的普通方法)一样定义的，所以我们来定义一个只有default方法的接口并且实现一下这个接口试一<br>试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4396</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMethod</span> <span class="keyword">implements</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultMethod defaultMethod = <span class="keyword">new</span> DefaultMethod();</span><br><span class="line">        System.out.println(defaultMethod.defaultMethod());</span><br><span class="line">        <span class="comment">//compile error : Non-static method 'defaultMethod()' cannot be referenced from a static context</span></span><br><span class="line">        <span class="comment">//! DefaultMethod.defaultMethod();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到default方法确实像实例方法一样，必须有实例对象才能调用，并且子类在实现接口时，可以不用实现default方法，也可以选择覆盖该方法。<br>这有点像子类继承父类实例方法。<br><br><br>接口静态方法就像是类静态方法，唯一的区别是<strong>接口静态方法只能通过接口名调用，而类静态方法既可以通过类名调用也可以通过实例调用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Static</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">staticMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4396</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> ... main(String...args)</span><br><span class="line">    <span class="comment">//!compile error: Static method may be invoked on containing interface class only</span></span><br><span class="line">    <span class="comment">//!aInstanceOfStatic.staticMethod();</span></span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>另一个问题是多继承问题，大家知道Java中类是不支持多继承的，但是接口是多继承和多实现(implements后跟多个接口)的，<br>那么如果一个接口继承另一个接口，两个接口都有同名的default方法会怎么样呢？答案是会像类继承一样覆写(@Override)，以下代码在IDE中可以顺利编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4396</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Default2</span> <span class="keyword">extends</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9527</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMethod</span> <span class="keyword">implements</span> <span class="title">Default</span>,<span class="title">Default2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultMethod defaultMethod = <span class="keyword">new</span> DefaultMethod();</span><br><span class="line">        System.out.println(defaultMethod.defaultMethod());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出 : <span class="number">9527</span></span><br></pre></td></tr></table></figure>

<p>出现上面的情况时，会优先找继承树上近的方法，类似于“短路优先”。<br><br><br>那么如果一个类实现了两个没有继承关系的接口，且这两个接口有同名方法的话会怎么样呢？IDE会要求你重写这个冲突的方法，让你自己选择去执行哪个方法，因为IDE它还没智能到你不告诉它，它就知道你想执行哪个方法。可以通过<figure class="highlight java"><figcaption><span>接口名.super```指针来访问接口中定义的实例(default)方法。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">```java</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4396</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Default2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9527</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果不重写</span></span><br><span class="line"><span class="comment">//compile error : defaults.DefaultMethod inherits unrelated defaults for defaultMethod() from types defaults.Default and defaults.Default2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMethod</span> <span class="keyword">implements</span> <span class="title">Default</span>,<span class="title">Default2</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Default.<span class="keyword">super</span>.defaultMethod());</span><br><span class="line">        System.out.println(Default2.<span class="keyword">super</span>.defaultMethod());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">996</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DefaultMethod defaultMethod = <span class="keyword">new</span> DefaultMethod();</span><br><span class="line">        System.out.println(defaultMethod.defaultMethod());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">运行输出 : </span><br><span class="line"><span class="number">4396</span></span><br><span class="line"><span class="number">9527</span></span><br><span class="line"><span class="number">996</span></span><br></pre></td></tr></table></figure></p>
<!-- ---------------------------------------------------接口默认方法结束---------------------------------------------------- -->
<hr>
<!-- --------------------------------------------------- 改进的类型推断 ---------------------------------------------------- -->
<p><span id="ImprovedTypeInference"></span></p>
<h2 id="改进的类型推断"><a href="#改进的类型推断" class="headerlink" title="　　　　　　　　　　　　　改进的类型推断"></a>　　　　　　　　　　　　　改进的类型推断</h2><h3 id="1-什么是类型推断"><a href="#1-什么是类型推断" class="headerlink" title="1.什么是类型推断"></a>1.什么是类型推断</h3><p>类型推断就像它的字面意思一样，编译器根据<b><i>你显示声明的已知的信息</i></b> 推断出你没有显示声明的类型，这就是类型推断。<br>看过《Java编程思想 第四版》的朋友可能还记得里面讲解泛型一章的时候，里面很多例子是下面这样的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; map = <span class="keyword">new</span> Map&lt;String, Object&gt;();</span><br></pre></td></tr></table></figure>

<p>而我们平常写的都是这样的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; map = <span class="keyword">new</span> Map&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>这就是类型推断，《Java编程思想 第四版》这本书出书的时候最新的JDK只有1.6(JDK7推出的类型推断)，在Java编程思想里Bruce Eckel大叔还提到过这个问题<br>(可能JDK的官方人员看了Bruce Eckel大叔的Thinking in Java才加的类型推断，☺)，在JDK7中推出了上面这样的类型推断，可以减少一些无用的代码。<br>(Java编程思想到现在还只有第四版，是不是因为Bruce Eckel大叔觉得Java新推出的语言特性“然并卵”呢？/滑稽)<br><br><br>在JDK7中，类型推断只有上面例子的那样的能力，即只有在使用<strong>赋值语句</strong>时才能自动推断出泛型参数信息(即&lt;&gt;里的信息)，下面的官方文档里的例子在JDK7里会编译<br>错误</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">stringList.add(<span class="string">"A"</span>);</span><br><span class="line"><span class="comment">//error : addAll(java.util.Collection&lt;? extends java.lang.String&gt;)in List cannot be applied to (java.util.List&lt;java.lang.Object&gt;)</span></span><br><span class="line">stringList.addAll(Arrays.asList());</span><br></pre></td></tr></table></figure>

<p>但是上面的代码在JDK8里可以通过，也就说，JDK8里，类型推断不仅可以用于赋值语句，而且可以根据代码中上下文里的信息推断出更多的信息，因此我们需要些的代码<br>会更少。加强的类型推断还有一个就是用于Lambda表达式了。<br><br><br>大家其实不必细究类型推断，在日常使用中IDE会自动判断，当IDE自己无法推断出足够的信息时，就需要我们额外做一下工作，比如在&lt;&gt;里添加更多的类型信息，<br>相信随着Java的进化，这些便利的功能会越来越强大。</p>
<!-- --------------------------------------------------- 改进的类型推断结束------------------------------------------------- -->
<hr>
<!-- --------------------------------------------------- 反射获得方法参数信息------------------------------------------------- -->
<p><span id="MethodParameterReflection"></span></p>
<h2 id="通过反射获得方法的参数信息"><a href="#通过反射获得方法的参数信息" class="headerlink" title="　　　　　　　　　　　　　通过反射获得方法的参数信息"></a>　　　　　　　　　　　　　通过反射获得方法的参数信息</h2><p>JDK8之前 .class文件是不会存储方法参数信息的，因此也就无法通过反射获取该信息(想想反射获取类信息的入口是什么？当然就是Class类了)。即是是在JDK11里<br>也不会默认生成这些信息，可以通过在javac加上-parameters参数来让javac生成这些信息(javac就是java编译器，可以把java文件编译成.class文件)。生成额外<br>的信息(运行时非必须信息)会消耗内存并且有可能公布敏感信息(某些方法参数比如password，JDK文档里这么说的)，并且确实很多信息javac并不会为我们生成，比如<br>LocalVariableTable，javac就不会默认生成，需要你加上 -g:vars来强制让编译器生成，同样的，方法参数信息也需要加上<br>-parameters来让javac为你在.class文件中生成这些信息，否则运行时反射是无法获取到这些信息的。在讲解Java语言层面的方法之前，先看一下javac加上该<br>参数和不加生成的信息有什么区别(不感兴趣想直接看运行代码的可以跳过这段)。下面是随便写的一个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteCodeParameters</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">simpleMethod</span><span class="params">(String canUGetMyName, Object yesICan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"9527"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先来不加参数编译和反编译一下这个类javac ByteCodeParameters.java , javap -v ByteCodeParameters:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//只截取了部分信息</span></span><br><span class="line"><span class="keyword">public</span> java.lang.<span class="function">String <span class="title">simpleMethod</span><span class="params">(java.lang.String, java.lang.Object)</span></span>;</span><br><span class="line">  descriptor: (Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">  flags: (<span class="number">0x0001</span>) ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">3</span>, args_size=<span class="number">3</span></span><br><span class="line">       0: ldc           #2                  // String 9527</span><br><span class="line">       <span class="number">2</span>: areturn</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">5</span>: <span class="number">0</span></span><br><span class="line"><span class="comment">//这个方法的描述到这里就结束了</span></span><br></pre></td></tr></table></figure>

<p>接下来我们加上参数javac -parameters ByteCodeParameters.java 再来看反编译的信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> java.lang.<span class="function">String <span class="title">simpleMethod</span><span class="params">(java.lang.String, java.lang.Object)</span></span>;</span><br><span class="line">   descriptor: (Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">   flags: (<span class="number">0x0001</span>) ACC_PUBLIC</span><br><span class="line">   Code:</span><br><span class="line">     stack=<span class="number">1</span>, locals=<span class="number">3</span>, args_size=<span class="number">3</span></span><br><span class="line">        0: ldc           #2                  // String 9527</span><br><span class="line">        <span class="number">2</span>: areturn</span><br><span class="line">     LineNumberTable:</span><br><span class="line">       line <span class="number">8</span>: <span class="number">0</span></span><br><span class="line">   MethodParameters:</span><br><span class="line">     Name                           Flags</span><br><span class="line">     canUGetMyName</span><br><span class="line">     yesICan</span><br></pre></td></tr></table></figure>

<p>可以看到.class文件里多了一个MethodParameters信息，这就是参数的名字，可以看到默认是不保存的。<br><br>下面看一下在Intelj Idea里运行的这个例子，我们试一下通过反射获取方法名 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteCodeParameters</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">simpleMethod</span><span class="params">(String canUGetMyName, Object yesICan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"9527"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = ByteCodeParameters.class;</span><br><span class="line">        Method simple = clazz.getDeclaredMethod(<span class="string">"simpleMethod"</span>, String.class, Object.class);</span><br><span class="line">        Parameter[] parameters = simple.getParameters();</span><br><span class="line">        <span class="keyword">for</span> (Parameter p : parameters) &#123;</span><br><span class="line">            System.out.println(p.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出 :</span><br><span class="line">arg0</span><br><span class="line">arg1</span><br></pre></td></tr></table></figure>

<p>？？？说好的方法名呢？？？？别急，哈哈。前面说了，默认是不生成参数名信息的，因此我们需要做一些配置，我们找到IDEA的settings里的Java Compiler选项，在<br>Additional command line parameters:一行加上-parameters(Eclipse 也是找到Java Compiler选中Stoer information about method parameters)，或者自<br>己编译一个.class文件放在IDEA的out下，然后再来运行 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输出 :</span><br><span class="line">canUGetMyName</span><br><span class="line">yesICan</span><br></pre></td></tr></table></figure>

<p>这样我们就通过反射获取到参数信息了。想要了解更多的同学可以自己研究一下 [官方文档]<br>(<a href="https://docs.oracle.com/javase/tutorial/reflect/member/methodparameterreflection.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/tutorial/reflect/member/methodparameterreflection.html</a>)<br><br></p>
<h2 id="总结与补充"><a href="#总结与补充" class="headerlink" title="总结与补充"></a>总结与补充</h2><p>在JDK8之后，可以通过-parameters参数来让编译器生成参数信息然后在运行时通过反射获取方法参数信息，其实在SpringFramework<br>里面也有一个LocalVariableTableParameterNameDiscoverer对象可以获取方法参数名信息，有兴趣的同学可以自行百度(这个类在打印日志时可能会比较有用吧，个人感觉)。</p>
<!-- --------------------------------------------------- 反射获得方法参数信息结束------------------------------------------------- -->
<hr>
<!-- --------------------------------------------------- JDK8流库------------------------------------------------------------- -->
<p><span id="stream"></span></p>
<!-- --------------------------------------------------- JDK8流库结束------------------------------------------------- -->

<hr>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="https://dirsky.github.io/2015/08/26/os-linux-CentOS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frank">
      <meta itemprop="description" content="优秀是一种习惯">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="徐先生的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2015/08/26/os-linux-CentOS/" class="post-title-link" itemprop="url">Centos常用命令</a>
          
        </h1>

        <div class="post-meta">

		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2015-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-26T00:00:00+08:00">2015-08-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-09 10:00:27" itemprop="dateModified" datetime="2021-08-09T10:00:27+08:00">2021-08-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2015/08/26/os-linux-CentOS/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2015/08/26/os-linux-CentOS/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>6.4k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>6 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h1><p>username:root<br>password:安装时设置的密码  </p>
<p>其它终端登录 <code>$ ssh root@192.168.0.23</code>  </p>
<h1 id="系统配置情况命令"><a href="#系统配置情况命令" class="headerlink" title="系统配置情况命令"></a>系统配置情况命令</h1><h2 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/redhat-release # CentOS 查看系统信息</span><br><span class="line">uname -a                # 查看内核/操作系统/CPU信息</span><br><span class="line">head -n 1 /etc/issue    # 查看操作系统版本</span><br><span class="line">cat /proc/cpuinfo       # 查看CPU信息</span><br><span class="line">hostname                # 查看计算机名</span><br><span class="line">lspci -tv               # 列出所有PCI设备</span><br><span class="line">lsusb -tv               # 列出所有USB设备</span><br><span class="line">lsmod                   # 列出加载的内核模块</span><br><span class="line">env                     # 查看环境变量</span><br><span class="line">dmidecode | grep "Product Nmae"   #查看服务器型号</span><br></pre></td></tr></table></figure>

<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">free -m                # 查看内存使用量和交换区使用量</span><br><span class="line">df -h                  # 查看各分区使用情况</span><br><span class="line">du -sh &lt;目录名&gt;        # 查看指定目录的大小</span><br><span class="line">grep MemTotal /proc/meminfo   # 查看内存总量</span><br><span class="line">grep MemFree /proc/meminfo    # 查看空闲内存量</span><br><span class="line">uptime                 # 查看系统运行时间、用户数、负载</span><br><span class="line">cat /proc/loadavg      # 查看系统负载</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存的插槽数，已经使用多少插槽。每条内存多大，已使用内存多大</span></span><br><span class="line">dmidecode|grep -P -A5 "Memory\s+Device"|grep Size|grep -v Range </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存支持的最大内存容量</span></span><br><span class="line">dmidecode|grep -P 'Maximum\s+Capacity'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存的频率</span></span><br><span class="line">dmidecode|grep -A16 "Memory Device"</span><br><span class="line">dmidecode|grep -A16 "Memory Device"|grep 'Speed'</span><br></pre></td></tr></table></figure>

<h2 id="磁盘和分区"><a href="#磁盘和分区" class="headerlink" title="磁盘和分区"></a>磁盘和分区</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mount | column -t      # 查看挂接的分区状态</span><br><span class="line">fdisk -l               # 查看所有分区</span><br><span class="line">swapon -s              # 查看所有交换分区</span><br><span class="line">hdparm -i /dev/hda     # 查看磁盘参数(仅适用于IDE设备)</span><br><span class="line">dmesg | grep IDE       # 查看启动时IDE设备检测状况</span><br></pre></td></tr></table></figure>

<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ifconfig               # 查看所有网络接口的属性</span><br><span class="line">iptables -L            # 查看防火墙设置</span><br><span class="line">route -n               # 查看路由表</span><br><span class="line">netstat -lntp          # 查看所有监听端口</span><br><span class="line">netstat -antp          # 查看所有已经建立的连接</span><br><span class="line">netstat -s             # 查看网络统计信息</span><br></pre></td></tr></table></figure>

<h2 id="进程查看"><a href="#进程查看" class="headerlink" title="进程查看"></a>进程查看</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef                 # 查看所有进程</span><br><span class="line">top                    # 实时显示进程状态</span><br></pre></td></tr></table></figure>

<h2 id="系统时间"><a href="#系统时间" class="headerlink" title="系统时间"></a>系统时间</h2><p><strong>UTC</strong>: 整个地球分为二十四时区，每个时区都有自己的本地时间。在国际无线电通信场合，为了统一起见，使用一个统一的时间，称为通用协调时(UTC, Universal Time Coordinated)。<br><strong>GMT</strong>: 格林威治标准时间 (Greenwich Mean Time)指位于英国伦敦郊区的皇家格林尼治天文台的标准时间，因为本初子午线被定义在通过那里的经线。(UTC与GMT时间基本相同)<br><strong>CST</strong>: 中国标准时间 (China Standard Time)。<code>GMT + 8 = UTC + 8 = CST</code><br><strong>DST</strong>: 夏令时(Daylight Saving Time) 指在夏天太阳升起的比较早时，将时钟拨快一小时，以提早日光的使用。(中国不使用)<br><strong>硬件时钟</strong>: RTC(Real-Time Clock)或CMOS时钟，一般在主板上靠电池供电，服务器断电后也会继续运行。仅保存日期时间数值，无法保存时区和夏令时设置。<br><strong>系统时钟</strong>: 一般在服务器启动时复制RTC时间，之后独立运行，保存了时间、时区和夏令时设置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">timedatectl  <span class="comment"># 等同于 timedatectl status</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-time <span class="string">"YYYY-MM-DD HH:MM:SS"</span>  <span class="comment"># 设置时间</span></span><br><span class="line">timedatectl list-timezones                  <span class="comment"># 列出所有时区</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai      <span class="comment"># 设置时区</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-ntp yes                     <span class="comment"># 是否NTP服务器同步, yes或者no</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将硬件时钟调整为与本地时钟一致</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-local-rtc 1</span><br><span class="line">hwclock --systohc --localtime <span class="comment"># 与上面命令效果一致   </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 硬件时间设置成 UTC</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-local-rtc 1</span><br><span class="line">hwclock --systohc --utc //与上面命令效果一致</span><br></pre></td></tr></table></figure>

<h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">w                         # 查看活动用户</span><br><span class="line">id &lt;用户名&gt;                # 查看指定用户信息</span><br><span class="line">last                      # 查看用户登录日志</span><br><span class="line">cut -d: -f1 /etc/passwd   # 查看系统所有用户</span><br><span class="line">cut -d: -f1 /etc/group    # 查看系统所有组</span><br><span class="line">crontab -l                # 查看当前用户的计划任务</span><br></pre></td></tr></table></figure>

<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网络接口统计数据的，两种发放  </span></span><br><span class="line">ip link # 或者下面方法</span><br><span class="line">ip -s link </span><br><span class="line"></span><br><span class="line">yum install net-tools # net-tools包提供了ifconfig命令  </span><br><span class="line">ifconfig -a # 查看IP地址  </span><br><span class="line">ip addr # 查看IP地址   </span><br><span class="line">route -n # 使用最快的速度查找主机的路由  </span><br><span class="line"></span><br><span class="line">cat /proc/version # 查看系统信息  </span><br><span class="line">  uname -a # 方法二  </span><br><span class="line">  uname -r #方法三  </span><br><span class="line">getconf LONG_BIT # 查看系统是64位还是32位  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uname -a  # 查看内核/操作系统/CPU信息  </span><br><span class="line">head -n 1 /etc/issue  #查看操作系统版本  </span><br><span class="line">cat /proc/cpuinfo  #查看CPU信息  </span><br><span class="line">hostname   #查看计算机名  </span><br><span class="line">lspci -tv  #列出所有PCI设备  </span><br><span class="line">lsusb -tv  #列出所有USB设备  </span><br><span class="line">lsmod  #列出加载的内核模块  </span><br><span class="line">env    #查看环境变量  </span><br><span class="line">arch   # 显示机器的处理器架构(1)  </span><br><span class="line">uname -m  # 显示机器的处理器架构(2)  </span><br><span class="line">uname -r  # 显示正在使用的内核版本  </span><br><span class="line">dmidecode -q  # 显示硬件系统部件  </span><br><span class="line">hdparm -i /dev/hda   # 罗列一个磁盘的架构特性  </span><br><span class="line">hdparm -tT /dev/sda  # 在磁盘上执行测试性读取操作  </span><br><span class="line">cat /proc/interrupts # 显示中断  </span><br><span class="line">cat /proc/meminfo  # 校验内存使用  </span><br><span class="line">cat /proc/swaps    # 显示哪些swap被使用  </span><br><span class="line">cat /proc/version  # 显示内核的版本  </span><br><span class="line">cat /proc/net/dev  # 显示网络适配器及统计  </span><br><span class="line">cat /proc/mounts   # 显示已加载的文件系统  </span><br><span class="line">lspci -tv  # 罗列 PCI 设备  </span><br><span class="line">lsusb -tv  # 显示 USB 设备  </span><br><span class="line">date  # 显示系统日期  </span><br><span class="line">date 041217002007.00  # 设置日期和时间 – 月日时分年.秒  </span><br><span class="line">cal 2007  # 显示2007年的日历表  </span><br><span class="line">clock -w  # 将时间修改保存到 BIOS</span><br></pre></td></tr></table></figure>

<h2 id="系统的关机、重启以及登出"><a href="#系统的关机、重启以及登出" class="headerlink" title="系统的关机、重启以及登出"></a>系统的关机、重启以及登出</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now <span class="comment"># 关闭系统(1)   </span></span><br><span class="line">init 0 <span class="comment"># 关闭系统(2)   </span></span><br><span class="line">telinit 0 <span class="comment"># 关闭系统(3)   </span></span><br><span class="line">shutdown -h hours:minutes &amp;  <span class="comment">#按预定时间关闭系统   </span></span><br><span class="line">shutdown -c  <span class="comment">#取消按预定时间关闭系统   </span></span><br><span class="line">shutdown -r now <span class="comment"># 重启  (1)   </span></span><br><span class="line">reboot  <span class="comment">#重启  (2)   </span></span><br><span class="line"><span class="built_in">logout</span> <span class="comment"># 注销</span></span><br></pre></td></tr></table></figure>

<h2 id="查看网络配置的命令"><a href="#查看网络配置的命令" class="headerlink" title="查看网络配置的命令"></a>查看网络配置的命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ifconfig <span class="comment"># 查看所有网络接口的属性   </span></span><br><span class="line">iptables -L <span class="comment"># 查看防火墙设置   </span></span><br><span class="line">route -n <span class="comment"># 查看路由表   </span></span><br><span class="line">netstat -lntp <span class="comment"># 查看所有监听端口   </span></span><br><span class="line">netstat -antp <span class="comment"># 查看所有已经建立的连接   </span></span><br><span class="line">netstat -s <span class="comment"># 查看网络统计信息</span></span><br></pre></td></tr></table></figure>

<h2 id="查看linux进程"><a href="#查看linux进程" class="headerlink" title="查看linux进程"></a>查看linux进程</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep node <span class="comment"># 查看`node`进程  </span></span><br><span class="line">ps -ef <span class="comment"># 查看所有进程   </span></span><br><span class="line">top <span class="comment"># 实时显示进程状态</span></span><br></pre></td></tr></table></figure>

<h2 id="杀进程"><a href="#杀进程" class="headerlink" title="杀进程"></a>杀进程</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">killall -9 websocket <span class="comment"># 干掉`websocket`服务进程  </span></span><br><span class="line">ps aux | grep mysql <span class="comment"># 查看mysql进程  </span></span><br><span class="line"><span class="built_in">kill</span> -9 35562 <span class="comment"># 根据进程号杀</span></span><br></pre></td></tr></table></figure>

<h2 id="查看用户的命令"><a href="#查看用户的命令" class="headerlink" title="查看用户的命令"></a>查看用户的命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">w <span class="comment"># 查看活动用户   </span></span><br><span class="line">id &lt;用户名&gt; <span class="comment"># 查看指定用户信息   </span></span><br><span class="line">last <span class="comment"># 查看用户登录日志   </span></span><br><span class="line">cut -d: -f1 /etc/passwd <span class="comment"># 查看系统所有用户   </span></span><br><span class="line">cut -d: -f1 /etc/group <span class="comment"># 查看系统所有组   </span></span><br><span class="line">crontab -l <span class="comment"># 查看当前用户的计划任务</span></span><br></pre></td></tr></table></figure>

<h2 id="log日志查看"><a href="#log日志查看" class="headerlink" title="log日志查看"></a>log日志查看</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/messages <span class="comment"># 查询日志的全部内容</span></span><br><span class="line">head -5 /var/<span class="built_in">log</span>/messages <span class="comment"># 查询日志的前5行</span></span><br><span class="line">tail -5 /var/<span class="built_in">log</span>/messages <span class="comment"># 查询日志的最新5行</span></span><br><span class="line">sed -n <span class="string">'5,10p'</span> /var/<span class="built_in">log</span>/messages <span class="comment"># 查询日志的5到10行</span></span><br></pre></td></tr></table></figure>

<h2 id="查看系统服务的命令"><a href="#查看系统服务的命令" class="headerlink" title="查看系统服务的命令"></a>查看系统服务的命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig –list <span class="comment"># 列出所有系统服务   </span></span><br><span class="line">chkconfig –list | grep on <span class="comment"># 列出所有启动的系统服务</span></span><br></pre></td></tr></table></figure>

<h2 id="安装程序的命令"><a href="#安装程序的命令" class="headerlink" title="安装程序的命令"></a>安装程序的命令</h2><p><code>rpm -qa</code> 查看所有安装的软件包  </p>
<h2 id="获取帮助的命令"><a href="#获取帮助的命令" class="headerlink" title="获取帮助的命令"></a>获取帮助的命令</h2><p><code>man &lt;命令&gt;</code> 获得命令帮助  </p>
<h1 id="安装软件方法"><a href="#安装软件方法" class="headerlink" title="安装软件方法"></a>安装软件方法</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装下载工具wget</span></span><br><span class="line">$ yum install wget</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">$ wget https://nodejs.org/dist/v4.4.4/node-v4.4.4-linux-x64.tar.xz</span><br><span class="line">       https://nodejs.org/dist/v4.4.5/node-v4.4.5-linux-x64.tar.xz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试安装</span></span><br><span class="line"><span class="comment"># 没有用到`gzip`压缩去掉`z`参数</span></span><br><span class="line">$ sudo tar --strip-components 1 -xzvf node-v* -C /usr/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<h1 id="yum错误"><a href="#yum错误" class="headerlink" title="yum错误"></a>yum错误</h1><p>yum错误：Cannot retrieve repository metadata (repomd.xml) for repository解决方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>

<p>找到<code>yum.repos.d</code>这个目录，里面有个文件，以<code>.repo</code> 结尾的，例如<code>zl.repo</code>删除<br>然后<code>#yum clean all</code>  </p>
<h1 id="安装源"><a href="#安装源" class="headerlink" title="安装源"></a>安装源</h1><p><a href="http://dl.fedoraproject.org/pub/" target="_blank" rel="noopener">http://dl.fedoraproject.org/pub/</a><br><a href="http://rpms.remirepo.net/enterprise/" target="_blank" rel="noopener">http://rpms.remirepo.net/enterprise/</a></p>
<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><p><a href="https://www.centos.org/" target="_blank" rel="noopener">www.centos.org</a></p>
<p><a href="http://mirror.neu.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirror.neu.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://centos.ustc.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://centos.ustc.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.163.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.163.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.hust.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.hust.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.zju.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.zju.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.cqu.edu.cn/CentOS/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.cqu.edu.cn/CentOS/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.cug.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.cug.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.neusoft.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.neusoft.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.skyshe.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.skyshe.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.aliyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.aliyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.nwsuaf.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.nwsuaf.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirror.bit.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirror.bit.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirror.lzu.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirror.lzu.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://ftp.sjtu.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://ftp.sjtu.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.yun-idc.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.yun-idc.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a><br><a href="http://mirrors.pubyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso" target="_blank" rel="noopener">http://mirrors.pubyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso</a> </p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="https://dirsky.github.io/2015/08/26/os-linux-CentOS7安装维护Gitlab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frank">
      <meta itemprop="description" content="优秀是一种习惯">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="徐先生的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2015/08/26/os-linux-CentOS7安装维护Gitlab/" class="post-title-link" itemprop="url">CentOS7安装维护Gitlab</a>
          
        </h1>

        <div class="post-meta">

		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2015-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-26T00:00:00+08:00">2015-08-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-09 10:00:27" itemprop="dateModified" datetime="2021-08-09T10:00:27+08:00">2021-08-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2015/08/26/os-linux-CentOS7安装维护Gitlab/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2015/08/26/os-linux-CentOS7安装维护Gitlab/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>18k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>16 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="官方安装"><a href="#官方安装" class="headerlink" title="官方安装"></a>官方安装</h2><p>下面是官网复制过来的官方安装方法，最简单的安装，在我大天朝，只能望天兴叹，你可翻墙安装或者略过这里，看下面的。</p>
<ol>
<li>安装并配置必要的依赖项</li>
</ol>
<p>If you install Postfix to send email please select ‘Internet Site’ during setup. Instead of using Postfix you can also use Sendmail or configure a custom SMTP server and configure it as an SMTP server.</p>
<p>On Centos 6 and 7, the commands below will also open HTTP and SSH access in the system firewall.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install curl openssh-server openssh-clients postfix cronie</span><br><span class="line">sudo service postfix start</span><br><span class="line">sudo chkconfig postfix on</span><br><span class="line">sudo lokkit -s http -s ssh</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加gitlab服务器包和安装包</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br><span class="line">sudo yum install gitlab-ce</span><br></pre></td></tr></table></figure>

<p>If you are not comfortable installing the repository through a piped script, you can find the entire script here and select and download the package manually and install using<br><a href="https://packages.gitlab.com/gitlab/gitlab-ce" target="_blank" rel="noopener">gitlab/gitlab-ce</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -LJO https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/6/gitlab-ce-XXX.rpm/download</span><br><span class="line">curl -LJO https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.2.2-ce.0.el7.x86_64.rpm/download</span><br><span class="line">rpm -i gitlab-ce-XXX.rpm</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置并启动GitLab</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>浏览器打开并登录</li>
</ol>
<p>On your first visit, you’ll be redirected to a password reset screen to provide the password for the initial administrator account. Enter your desired password and you’ll be redirected back to the login screen.</p>
<p>The default account’s username is root. Provide the password you created earlier and login. After login you can change the username if you wish.</p>
<h2 id="第三方镜像安装"><a href="#第三方镜像安装" class="headerlink" title="第三方镜像安装"></a>第三方镜像安装</h2><ul>
<li><a href="https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/" target="_blank" rel="noopener">Gitlab Community Edition 镜像使用帮助</a></li>
<li><a href="https://github.com/hehongwei44/my-blog/issues/19" target="_blank" rel="noopener">在阿里云上通过Omnibus一键安装包安装Gitlab</a></li>
</ul>
<h3 id="编辑源"><a href="#编辑源" class="headerlink" title="编辑源"></a>编辑源</h3><p>新建 /etc/yum.repos.d/gitlab-ce.repo，内容为</p>
<p><a href="https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/" target="_blank" rel="noopener">使用清华大学 TUNA 镜像源</a> 打开网址将内容复制到<code>gitlab-ce.repo</code>文件中，编辑路径<code>vim /etc/yum.repos.d/gitlab-ce.repo</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[gitlab-ce]</span><br><span class="line">name=gitlab-ce</span><br><span class="line">baseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://packages.gitlab.com/gpg.key</span><br></pre></td></tr></table></figure>

<h3 id="更新本地YUM缓存"><a href="#更新本地YUM缓存" class="headerlink" title="更新本地YUM缓存"></a>更新本地YUM缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum makecache</span><br></pre></td></tr></table></figure>

<h3 id="安装社区版"><a href="#安装社区版" class="headerlink" title="安装社区版"></a>安装社区版</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gitlab-ce <span class="comment">#(自动安装最新版)</span></span><br><span class="line">sudo yum install gitlab-ce-8.15.2-ce.0.el6 <span class="comment">#(安装指定版本)</span></span><br></pre></td></tr></table></figure>

<h3 id="更改配置"><a href="#更改配置" class="headerlink" title="更改配置"></a>更改配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line"><span class="comment"># 找到 external_url 'http://000.00.00.00:8081'</span></span><br><span class="line"><span class="comment"># 修改成你的地址</span></span><br></pre></td></tr></table></figure>

<h3 id="配置并启动GitLab"><a href="#配置并启动GitLab" class="headerlink" title="配置并启动GitLab"></a>配置并启动GitLab</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开`/etc/gitlab/gitlab.rb`,</span></span><br><span class="line"><span class="comment"># 将`external_url = 'http://git.example.com'`修改为自己的IP地址：`http://xxx.xx.xxx.xx`，</span></span><br><span class="line"><span class="comment"># 然后执行下面的命令，对GitLab进行编译。</span></span><br><span class="line">sudo gitlab-ctl reconfigure</span><br><span class="line"><span class="comment"># 清除缓存</span></span><br><span class="line">sudo gitlab-rake cache:clear RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<h3 id="登录GitLab"><a href="#登录GitLab" class="headerlink" title="登录GitLab"></a>登录GitLab</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Username: root </span><br><span class="line">Password: 5iveL!fe</span><br></pre></td></tr></table></figure>

<h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><p><a href="https://github.com/jaywcjlove/docker-tutorial/blob/master/gitlab.md" target="_blank" rel="noopener">Docker 安装 Gitlab 教程</a></p>
<h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl uninstall</span><br></pre></td></tr></table></figure>

<h2 id="运维"><a href="#运维" class="headerlink" title="运维"></a>运维</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改默认的配置文件</span></span><br><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">sudo cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span><br><span class="line"><span class="comment"># echo "vm.overcommit_memory=1" &gt;&gt; /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># sysctl -p</span></span><br><span class="line"><span class="comment"># echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查gitlab</span></span><br><span class="line">gitlab-rake gitlab:check SANITIZE=<span class="literal">true</span> --trace</span><br><span class="line">gitlab-rake gitlab:check</span><br><span class="line">gitlab-rake gitlab:check SANITIZE=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">gitlab-ctl tail</span><br><span class="line"><span class="comment"># 数据库关系升级</span></span><br><span class="line">gitlab-rake db:migrate</span><br><span class="line"><span class="comment"># 清理缓存</span></span><br><span class="line">gitlab-rake cache:clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新gitlab包</span></span><br><span class="line">yum update gitlab-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级gitlab</span></span><br><span class="line">yum install gitlab-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级数据命令</span></span><br><span class="line">gitlab-ctl pg-upgrade</span><br></pre></td></tr></table></figure>

<h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl start <span class="comment"># 启动所有 gitlab 组件：</span></span><br><span class="line">gitlab-ctl stop  <span class="comment"># 停止所有 gitlab 组件：</span></span><br><span class="line">gitlab-ctl stop postgresql <span class="comment"># 停止所有 gitlab postgresql 组件：</span></span><br><span class="line"><span class="comment"># 停止相关数据连接服务</span></span><br><span class="line">gitlab-ctl stop unicorn</span><br><span class="line">gitlab-ctl stop sidekiq</span><br><span class="line">gitlab-ctl restart <span class="comment"># 重启所有 gitlab 组件：</span></span><br><span class="line">gitlab-ctl restart gitlab-workhorse <span class="comment"># 重启所有 gitlab gitlab-workhorse 组件：</span></span><br><span class="line">gitlab-ctl status <span class="comment"># 查看服务状态</span></span><br><span class="line">gitlab-ctl reconfigure <span class="comment"># 生成配置启动服务</span></span><br></pre></td></tr></table></figure>

<h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl tail <span class="comment"># 查看日志</span></span><br><span class="line">sudo gitlab-ctl tail redis <span class="comment"># 检查redis的日志</span></span><br><span class="line">sudo gitlab-ctl tail postgresql       <span class="comment"># 检查postgresql的日志</span></span><br><span class="line">sudo gitlab-ctl tail gitlab-workhorse <span class="comment"># 检查gitlab-workhorse的日志</span></span><br><span class="line">sudo gitlab-ctl tail logrotate <span class="comment"># 检查logrotate的日志</span></span><br><span class="line">sudo gitlab-ctl tail nginx    <span class="comment"># 检查nginx的日志</span></span><br><span class="line">sudo gitlab-ctl tail sidekiq  <span class="comment"># 检查sidekiq的日志</span></span><br><span class="line">sudo gitlab-ctl tail unicorn  <span class="comment"># 检查unicorn的日志</span></span><br></pre></td></tr></table></figure>

<h3 id="重置管理员密码"><a href="#重置管理员密码" class="headerlink" title="重置管理员密码"></a>重置管理员密码</h3><p>Gitlab管理员密码忘记，怎么重置密码，Gitlab 修改root用户密码，<a href="http://docs.gitlab.com/ce/security/reset_root_password.html" target="_blank" rel="noopener">How to reset your root password</a>。</p>
<p>使用rails工具打开终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-rails console production</span><br></pre></td></tr></table></figure>

<p>查询用户的email，用户名，密码等信息，id:1 表示root账号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user = User.where(id: 1).first</span><br></pre></td></tr></table></figure>

<p>重新设置密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user.password = <span class="string">'新密码'</span></span><br><span class="line">user.password_confirmation = <span class="string">'新密码'</span></span><br></pre></td></tr></table></figure>

<p>保存密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.save!</span><br></pre></td></tr></table></figure>

<p>完整的操作ruby脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user = User.where(id: 1).first</span><br><span class="line">user.password = <span class="string">'新密码'</span></span><br><span class="line">user.password_confirmation = <span class="string">'新密码'</span></span><br><span class="line">user.save!</span><br></pre></td></tr></table></figure>

<h2 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h2><p>使用Gitlab一键安装包安装Gitlab非常简单, 同样的备份恢复与迁移也非常简单,用一条命令即可创建完整的Gitlab备份:</p>
<h3 id="修改备份文件默认目录"><a href="#修改备份文件默认目录" class="headerlink" title="修改备份文件默认目录"></a>修改备份文件默认目录</h3><p>修改<code>/etc/gitlab/gitlab.rb</code>来修改默认存放备份文件的目录:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'backup_path'</span>] = <span class="string">'/mnt/backups'</span></span><br></pre></td></tr></table></figure>

<h3 id="创建备份"><a href="#创建备份" class="headerlink" title="创建备份"></a>创建备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure>

<p>以上命令将在 <code>/var/opt/gitlab/backups</code> 目录下创建一个名称类似为xxxxxxxx_gitlab_backup.tar的压缩包, 这个压缩包就是Gitlab整个的完整部分, 其中开头的xxxxxx是备份创建的时间戳。</p>
<p>修改后使用gitlab-ctl reconfigure命令重载配置文件。</p>
<h3 id="开始备份"><a href="#开始备份" class="headerlink" title="开始备份"></a>开始备份</h3><p>这里放你的备份文件文件夹，和仓库源文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/opt/gitlab/backups                   <span class="comment"># 备份文件文件夹</span></span><br><span class="line">/var/opt/gitlab/git-data/repositories     <span class="comment"># git仓库源文件</span></span><br></pre></td></tr></table></figure>

<h3 id="自动备份"><a href="#自动备份" class="headerlink" title="自动备份"></a>自动备份</h3><p>通过crontab使用备份命令实现自动备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line"><span class="comment"># 每天2点备份gitlab数据</span></span><br><span class="line">0 2 * * * /usr/bin/gitlab-rake gitlab:backup:create</span><br><span class="line">0 2 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure>

<p>上面两行保存之后，重新载入配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service crond reload</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">systemctl reload crond.service</span><br></pre></td></tr></table></figure>

<h3 id="备份保留七天"><a href="#备份保留七天" class="headerlink" title="备份保留七天"></a>备份保留七天</h3><p>设置只保存最近7天的备份，编辑 /etc/gitlab/gitlab.rb 配置文件，找到如下代码，删除注释 <code>#</code> 保存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/gitlab/gitlab.rb 配置文件 修改下面这一行</span></span><br><span class="line">gitlab_rails[<span class="string">'backup_keep_time'</span>] = 604800</span><br></pre></td></tr></table></figure>

<p>重新加载gitlab配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<h3 id="开始恢复"><a href="#开始恢复" class="headerlink" title="开始恢复"></a>开始恢复</h3><p>迁移如同备份与恢复的步骤一样, 只需要将老服务器 <code>/var/opt/gitlab/backups</code> 目录下的备份文件拷贝到新服务器上的 <code>/var/opt/gitlab/backups</code> 即可(如果你没修改过默认备份目录的话)。 然后执行恢复命令。<br>如果修改了，首先进入备份 gitlab 的目录，这个目录是配置文件中的 <code>gitlab_rails[&#39;backup_path&#39;]</code> ，默认为 <code>/var/opt/gitlab/backups</code> 。</p>
<p>然后停止 unicorn 和 sidekiq ，保证数据库没有新的连接，不会有写数据情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止相关数据连接服务</span></span><br><span class="line">gitlab-ctl stop unicorn</span><br><span class="line"><span class="comment"># ok: down: unicorn: 0s, normally up</span></span><br><span class="line">gitlab-ctl stop sidekiq</span><br><span class="line"><span class="comment"># ok: down: sidekiq: 0s, normally up</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从xxxxx编号备份中恢复</span></span><br><span class="line"><span class="comment"># 然后恢复数据，1406691018为备份文件的时间戳</span></span><br><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1406691018</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新版本 1483533591_2017_01_04_gitlab_backup.tar</span></span><br><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1483533591_2017_01_04_gitlab_backup.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Gitlab</span></span><br><span class="line">sudo gitlab-ctl start</span><br></pre></td></tr></table></figure>

<p>判断是执行实际操作的gitlab相关用户：git，没有得到足够的权限。依次执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 恢复过程中没有权限</span></span><br><span class="line">mkdir /var/opt/gitlab/backups</span><br><span class="line">chown git /var/opt/gitlab/backups</span><br><span class="line">chmod 700 /var/opt/gitlab/backups</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复成功页面报没有权限的错误</span></span><br><span class="line">sudo chown -R git:git /var/opt/gitlab/git-data/repositories</span><br><span class="line">sudo chmod -R ug+rwX,o-rwx /var/opt/gitlab/git-data/repositories</span><br><span class="line">sudo chmod -R ug<span class="_">-s</span> /var/opt/gitlab/git-data/repositories</span><br><span class="line">sudo find /var/opt/gitlab/git-data/repositories -<span class="built_in">type</span> d -print0 | sudo xargs -0 chmod g+s</span><br></pre></td></tr></table></figure>

<p>如果备份文件报没有权限，通过<code>ls -al</code>查看权限是不是<code>git</code>，而不是<code>root</code>，通过下面方式给<code>git</code>用户权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R git:git 1483533591_2017_01_04_gitlab_backup.tar</span><br></pre></td></tr></table></figure>

<h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登陆gitlab的安装服务查看配置文件</span></span><br><span class="line">cat /var/opt/gitlab/gitlab-rails/etc/database.yml </span><br><span class="line"></span><br><span class="line">vim /var/opt/gitlab/postgresql/data/postgresql.conf</span><br><span class="line"><span class="comment"># listen_addresses = '192.168.1.125' # 修改监听地址为ip</span></span><br><span class="line"><span class="comment"># 或者改为 "*"</span></span><br></pre></td></tr></table></figure>

<p>修改 <code>pg_hba.conf</code> 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim  /var/opt/gitlab/postgresql/data/pg_hba.conf</span><br><span class="line"><span class="comment"># 将下面这一行添加到配置的最后面</span></span><br><span class="line"><span class="comment"># host    all    all    0.0.0.0/0    trust</span></span><br></pre></td></tr></table></figure>

<p>如果不希望允许所有IP远程访问，则可以将上述配置项中的0.0.0.0设定为特定的IP值。</p>
<p>重启 <code>postgresql</code> 数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl restart postgresql</span><br></pre></td></tr></table></figure>

<p>查看 <code>/etc/passwd</code> 文件里边 <code>gitlab</code> 对应的系统用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]$ cat /etc/passwd</span><br><span class="line">...</span><br><span class="line">gitlab-psql:x:493:490::/var/opt/gitlab/postgresql:/bin/sh  <span class="comment"># gitlab的postgresql用户</span></span><br></pre></td></tr></table></figure>

<h2 id="一些常规目录"><a href="#一些常规目录" class="headerlink" title="一些常规目录"></a>一些常规目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置目录</span></span><br><span class="line">/etc/gitlab/gitlab.rb</span><br><span class="line"><span class="comment"># 生成好的nginx配置</span></span><br><span class="line">/var/opt/gitlab/nginx/conf/gitlab-http.conf</span><br><span class="line"><span class="comment"># 备份目录</span></span><br><span class="line">/var/opt/gitlab/backups</span><br></pre></td></tr></table></figure>

<h2 id="使用HTTPS"><a href="#使用HTTPS" class="headerlink" title="使用HTTPS"></a>使用HTTPS</h2><p>直接将nginx配置复制到你自己的nginx配置中，停掉gitlab的nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /var/opt/gitlab/nginx/conf/gitlab-http.conf /usr/<span class="built_in">local</span>/nginx/conf/vhost/</span><br></pre></td></tr></table></figure>

<p>将你的SSL证书配置复制进去</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">server_name</span>  g.doman.cn;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/*****/certificate.crt;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/*****/private.key;</span><br><span class="line">  <span class="comment"># .....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑<code>vi /usr/local/nginx/conf/nginx.conf</code>你的nginx配置，引用你复制过来的配置。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="comment"># .....</span></span><br><span class="line">  <span class="attribute">include</span> vhost/gitlab-http.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时要把<code>/var/opt/gitlab/nginx/conf/nginx.conf</code>中的一些变量复制到自己的nginx配置中<code>nginx.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="comment"># .....</span></span><br><span class="line">  <span class="attribute">log_format</span> gitlab_access <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request_method</span> <span class="variable">$filtered_request_uri</span> <span class="variable">$server_protocol</span>" <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$filtered_http_referer</span>" "<span class="variable">$http_user_agent</span>"'</span>;</span><br><span class="line">  <span class="attribute">log_format</span> gitlab_mattermost_access <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request_method</span> <span class="variable">$filtered_request_uri</span> <span class="variable">$server_protocol</span>" <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$filtered_http_referer</span>" "<span class="variable">$http_user_agent</span>"'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">proxy_cache_path</span> proxy_cache keys_zone=gitlab:<span class="number">10m</span> max_size=<span class="number">1g</span> levels=<span class="number">1</span>:<span class="number">2</span>;</span><br><span class="line">  <span class="attribute">proxy_cache</span> gitlab;</span><br><span class="line">  <span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">      <span class="attribute">default</span> upgrade;</span><br><span class="line">      ''      close;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Remove private_token from the request URI</span></span><br><span class="line">  <span class="comment"># In:  /foo?private_token=unfiltered&amp;authenticity_token=unfiltered&amp;rss_token=unfiltered&amp;...</span></span><br><span class="line">  <span class="comment"># Out: /foo?private_token=[FILTERED]&amp;authenticity_token=unfiltered&amp;rss_token=unfiltered&amp;...</span></span><br><span class="line">  <span class="attribute">map</span> <span class="variable">$request_uri</span> <span class="variable">$temp_request_uri_1</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    ~(?i)^(?&lt;start&gt;.*)(?&lt;temp&gt;[\?&amp;]private[\-_]token)=[^&amp;]*(?&lt;rest&gt;.*)$ "$start$temp=[FILTERED]$rest";</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># Remove authenticity_token from the request URI</span></span><br><span class="line">  <span class="comment"># In:  /foo?private_token=[FILTERED]&amp;authenticity_token=unfiltered&amp;rss_token=unfiltered&amp;...</span></span><br><span class="line">  <span class="comment"># Out: /foo?private_token=[FILTERED]&amp;authenticity_token=[FILTERED]&amp;rss_token=unfiltered&amp;...</span></span><br><span class="line">  <span class="attribute">map</span> <span class="variable">$temp_request_uri_1</span> <span class="variable">$temp_request_uri_2</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> <span class="variable">$temp_request_uri_1</span>;</span><br><span class="line">    ~(?i)^(?&lt;start&gt;.*)(?&lt;temp&gt;[\?&amp;]authenticity[\-_]token)=[^&amp;]*(?&lt;rest&gt;.*)$ "$start$temp=[FILTERED]$rest";</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># Remove rss_token from the request URI</span></span><br><span class="line">  <span class="comment"># In:  /foo?private_token=[FILTERED]&amp;authenticity_token=[FILTERED]&amp;rss_token=unfiltered&amp;...</span></span><br><span class="line">  <span class="comment"># Out: /foo?private_token=[FILTERED]&amp;authenticity_token=[FILTERED]&amp;rss_token=[FILTERED]&amp;...</span></span><br><span class="line">  <span class="attribute">map</span> <span class="variable">$temp_request_uri_2</span> <span class="variable">$filtered_request_uri</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> <span class="variable">$temp_request_uri_2</span>;</span><br><span class="line">    ~(?i)^(?&lt;start&gt;.*)(?&lt;temp&gt;[\?&amp;]rss[\-_]token)=[^&amp;]*(?&lt;rest&gt;.*)$ "$start$temp=[FILTERED]$rest";</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># A version of the referer without the query string</span></span><br><span class="line">  <span class="attribute">map</span> <span class="variable">$http_referer</span> <span class="variable">$filtered_http_referer</span> &#123;</span><br><span class="line">    <span class="attribute">default</span> <span class="variable">$http_referer</span>;</span><br><span class="line">    ~^(?&lt;temp&gt;.*)\? $temp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="暴力升级"><a href="#暴力升级" class="headerlink" title="暴力升级"></a>暴力升级</h2><p>暴力升级前先备份，然后停止所有服务运行，记得备份的良好习惯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl stop  <span class="comment"># 停止所有 gitlab 组件：</span></span><br><span class="line"><span class="comment"># 更新gitlab包</span></span><br><span class="line">yum update gitlab-ce</span><br></pre></td></tr></table></figure>

<p>直接编辑源 /etc/yum.repos.d/gitlab-ce.repo，安装 GitLab 社区版</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list gitlab-ce <span class="comment"># 查看版本</span></span><br><span class="line">sudo yum install gitlab-ce <span class="comment">#(自动安装最新版)</span></span><br><span class="line">sudo yum install gitlab-ce-8.15.2-ce.0.el6 <span class="comment">#(安装指定版本)</span></span><br></pre></td></tr></table></figure>

<p>注意：<code>10.7</code> 版本升级到 <code>11.x</code> 版本需要先升级到 <code>10.8</code> 版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装指定版本 10.8 的版本</span></span><br><span class="line">sudo yum install gitlab-ce-10.8.0-ce.0.el6</span><br></pre></td></tr></table></figure>

<p>安装完成记得将所有服务启起来哦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl start <span class="comment"># 启动所有数据库</span></span><br><span class="line"><span class="comment"># postgresql 数据库如果启动不了，通过重启启动</span></span><br><span class="line">gitlab-ctl restart postgresql</span><br></pre></td></tr></table></figure>

<p>安装过如果报错，查看提示根据提示操作，版本跨度太大会报错哦。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">gitlab preinstall: Automatically backing up only the GitLab SQL database (excluding everything else!)</span><br><span class="line">Dumping database ...</span><br><span class="line">Dumping PostgreSQL database gitlabhq_production ... pg_dump: [archiver (db)] connection to database &quot;gitlabhq_production&quot; failed: could not connect to server: 没有那个文件或目录</span><br><span class="line">    Is the server running locally and accepting</span><br><span class="line">    connections on Unix domain socket &quot;/var/opt/gitlab/postgresql/.s.PGSQL.5432&quot;?</span><br><span class="line">Backup failed</span><br><span class="line">[FAILED]</span><br><span class="line">gitlab preinstall:</span><br><span class="line">gitlab preinstall: Backup failed! If you want to skip this backup, run the following command and</span><br><span class="line">gitlab preinstall: try again:</span><br><span class="line">gitlab preinstall:</span><br><span class="line">gitlab preinstall:   sudo touch /etc/gitlab/skip-auto-migrations</span><br><span class="line">gitlab preinstall:</span><br><span class="line">error: %pre(gitlab-ce-8.15.2-ce.0.el6.x86_64) scriptlet failed, exit status 1</span><br><span class="line">Error in PREIN scriptlet in rpm package gitlab-ce-8.15.2-ce.0.el6.x86_64</span><br><span class="line">error:   install: %pre scriptlet failed (2), skipping gitlab-ce-8.15.2-ce.0.el6</span><br><span class="line">gitlab-ce-8.11.5-ce.0.el6.x86_64 was supposed to be removed but is not!</span><br><span class="line">  Verifying  : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             1/2</span><br><span class="line">  Verifying  : gitlab-ce-8.15.2-ce.0.el6.x86_64                                                                                                                                                             2/2</span><br><span class="line"></span><br><span class="line">Failed:</span><br><span class="line">  gitlab-ce.x86_64 0:8.11.5-ce.0.el6</span><br></pre></td></tr></table></figure>

<p>看上面一堆错误，瞬间就懵逼了，看到一条救星命令让我尝试运行 <code>sudo touch /etc/gitlab/skip-auto-migrations</code> 于是我二逼的重新<code>yum install gitlab-ce</code>运行了，结果真的安装成功了，😄。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新安装命令</span></span><br><span class="line">yum reinstall gitlab-ce</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">yum install gitlab-ce</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">gitlab: Thank you for installing GitLab!</span><br><span class="line">gitlab: To configure and start GitLab, RUN THE FOLLOWING COMMAND:</span><br><span class="line"></span><br><span class="line">sudo gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">gitlab: GitLab should be reachable at http://114.55.148.71:8081</span><br><span class="line">gitlab: Otherwise configure GitLab for your system by editing /etc/gitlab/gitlab.rb file</span><br><span class="line">gitlab: And running reconfigure again.</span><br><span class="line">gitlab:</span><br><span class="line">gitlab: For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="line">gitlab: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="line">gitlab:</span><br><span class="line"></span><br><span class="line">gitlab: GitLab now ships with a newer version of PostgreSQL (9.6.1), and will be used</span><br><span class="line">gitlab: as the default in the next major relase. To upgrade, RUN THE FOLLOWING COMMANDS:</span><br><span class="line"></span><br><span class="line">sudo gitlab-ctl pg-upgrade</span><br><span class="line"></span><br><span class="line">gitlab: For more details, please see:</span><br><span class="line">gitlab: https://docs.gitlab.com/omnibus/settings/database.html#upgrade-packaged-postgresql-server</span><br><span class="line">gitlab:</span><br><span class="line">  清理       : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             2/2</span><br><span class="line">Found /etc/gitlab/skip-auto-migrations, exiting...</span><br><span class="line">  Verifying  : gitlab-ce-8.15.2-ce.0.el6.x86_64                                                                                                                                                             1/2</span><br><span class="line">  Verifying  : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             2/2</span><br><span class="line"></span><br><span class="line">更新完毕:</span><br><span class="line">  gitlab-ce.x86_64 0:8.15.2-ce.0.el6</span><br><span class="line"></span><br><span class="line">完毕！</span><br></pre></td></tr></table></figure>

<p>重启配置，可以解决大部分<code>502</code>错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<h2 id="优化内存使用"><a href="#优化内存使用" class="headerlink" title="优化内存使用"></a>优化内存使用</h2><p>修改配置文件 <code>/etc/gitlab/gitlab.rb</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 减少 postgresql 数据库缓存</span></span><br><span class="line">postgresql[<span class="string">'shared_buffers'</span>] = <span class="string">"256MB"</span></span><br><span class="line"><span class="comment"># 减少sidekiq的并发数</span></span><br><span class="line">sidekiq[<span class="string">'concurrency'</span>] = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker进程数</span></span><br><span class="line">postgresql[<span class="string">'max_worker_processes'</span>] = 4</span><br><span class="line"></span><br><span class="line">unicorn[<span class="string">'worker_processes'</span>] = 2  <span class="comment">## worker进程数</span></span><br><span class="line">unicorn[<span class="string">'worker_memory_limit_min'</span>] = <span class="string">"400 * 1 &lt;&lt; 20"</span> <span class="comment">##worker最小内存</span></span><br><span class="line">unicorn[<span class="string">'worker_memory_limit_max'</span>] = <span class="string">"650 * 1 &lt;&lt; 20"</span> <span class="comment">##worker最大内存</span></span><br></pre></td></tr></table></figure>

<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><h3 id="解决80端口被占用"><a href="#解决80端口被占用" class="headerlink" title="解决80端口被占用"></a>解决80端口被占用</h3><p>nginx配置解决 <code>80</code> 端口被占用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> gitlab &#123;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">114.55.111.111:8081</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># 侦听的80端口</span></span><br><span class="line">  <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span>  git.diggg.cn;</span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span>   http://gitlab;    <span class="comment">#在这里设置一个代理，和upstream的名字一样</span></span><br><span class="line">    <span class="comment">#以下是一些反向代理的配置可删除</span></span><br><span class="line">    <span class="attribute">proxy_redirect</span>             <span class="literal">off</span>;</span><br><span class="line">    <span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span>           Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>           X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>           X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span>       <span class="number">10m</span>; <span class="comment">#允许客户端请求的最大单文件字节数</span></span><br><span class="line">    <span class="attribute">client_body_buffer_size</span>    <span class="number">128k</span>; <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span>      <span class="number">300</span>; <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">    <span class="attribute">proxy_send_timeout</span>         <span class="number">300</span>; <span class="comment">#后端服务器数据回传时间(代理发送超时)</span></span><br><span class="line">    <span class="attribute">proxy_read_timeout</span>         <span class="number">300</span>; <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line">    <span class="attribute">proxy_buffer_size</span>          <span class="number">4k</span>; <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">    <span class="attribute">proxy_buffers</span>              <span class="number">4</span> <span class="number">32k</span>; <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span></span><br><span class="line">    <span class="attribute">proxy_busy_buffers_size</span>    <span class="number">64k</span>; <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">    <span class="attribute">proxy_temp_file_write_size</span> <span class="number">64k</span>; <span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginx配置检查和立即生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查配置</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -tc conf/nginx.conf</span><br><span class="line"><span class="comment"># nginx 重新加载配置</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<h3 id="头像无法正常显示"><a href="#头像无法正常显示" class="headerlink" title="头像无法正常显示"></a>头像无法正常显示</h3><p>原因：gravatar被墙<br>解决办法：<br>编辑 /etc/gitlab/gitlab.rb，将</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitlab_rails['gravatar_plain_url'] = 'http://gravatar.duoshuo.com/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon'</span></span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[&apos;gravatar_plain_url&apos;] = &apos;http://gravatar.duoshuo.com/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon&apos;</span><br></pre></td></tr></table></figure>

<p>然后在命令行执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl reconfigure </span><br><span class="line">sudo gitlab-rake cache:clear RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<h3 id="internal-API-unreachable"><a href="#internal-API-unreachable" class="headerlink" title="internal API unreachable"></a>internal API unreachable</h3><p>这个错误是一个自己制造的坑，我克隆和提交都没有办法搞，但是网站能正常运行，尝试了非常多的方法，最终我的问题是<code>22</code>端口没有隐射出去，好尴尬。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GitLab: Failed to authorize your Git request: internal API unreachable</span><br></pre></td></tr></table></figure>

<p>解决办法：<a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/33702" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab-ce/issues/33702</a><br>通过防火墙规则 127.0.0.1  </p>
<h3 id="proxy-temp-目录没有权限"><a href="#proxy-temp-目录没有权限" class="headerlink" title="proxy_temp 目录没有权限"></a>proxy_temp 目录没有权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[crit] 14788<span class="comment">#0: *215 open() "/usr/local/nginx/proxy_temp/5/01/0000000015" failed (13: Permission denied) while reading upstream</span></span><br></pre></td></tr></table></figure>

<p>以下方式解决</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:root /usr/<span class="built_in">local</span>/nginx/proxy_temp</span><br><span class="line"><span class="comment"># 编辑 nginx.conf</span></span><br><span class="line">sudo vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"><span class="comment"># 在第一行添加</span></span><br><span class="line">user root;</span><br></pre></td></tr></table></figure>

<h3 id="webhooks-错误"><a href="#webhooks-错误" class="headerlink" title="webhooks 错误"></a>webhooks 错误</h3><p>错误显示不允许发送本地请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Url is blocked: Requests to the local network are not allowed</span><br></pre></td></tr></table></figure>

<p>解决方法，在设置中设置允许本地连接即可</p>
<blockquote>
<p><code>admin</code> =&gt; <code>Settings</code> =&gt; <code>Outbound requests</code></p>
</blockquote>
<h3 id="服务无法启动"><a href="#服务无法启动" class="headerlink" title="服务无法启动"></a>服务无法启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost gitlab]# gitlab-ctl status</span><br><span class="line">fail: alertmanager: runsv not running</span><br><span class="line">fail: gitaly: runsv not running</span><br><span class="line">fail: gitlab-monitor: runsv not running</span><br><span class="line">fail: gitlab-workhorse: runsv not running</span><br><span class="line">fail: logrotate: runsv not running</span><br><span class="line">fail: nginx: runsv not running</span><br><span class="line">fail: node-exporter: runsv not running</span><br><span class="line">fail: postgres-exporter: runsv not running</span><br><span class="line">fail: postgresql: runsv not running</span><br><span class="line">fail: prometheus: runsv not running</span><br><span class="line">fail: redis: runsv not running</span><br><span class="line">fail: redis-exporter: runsv not running</span><br><span class="line">fail: sidekiq: runsv not running</span><br><span class="line">fail: unicorn: runsv not running</span><br></pre></td></tr></table></figure>

<p><a href="https://confluence.jaytaala.com/pages/viewpage.action?pageId=9666568" target="_blank" rel="noopener"></a><br><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/issues/272" target="_blank" rel="noopener">Omnibus gitlab do not restart on CentOS7</a><br>开机自动启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl status gitlab-runsvdir.service -l</span><br><span class="line">● gitlab-runsvdir.service - GitLab Runit supervision process</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/gitlab-runsvdir.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br></pre></td></tr></table></figure>

<p>如果 <code>gitlab-runsvdir.service</code> 服务没有响应，你可能要看一下内存是否满了，需要释放内存，老的版本需要 2G 内存，新版本需要至少 4G 内存。</p>
<h3 id="其它错误"><a href="#其它错误" class="headerlink" title="其它错误"></a>其它错误</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error executing action `run` on resource <span class="string">'bash[migrate gitlab-rails database]'</span></span><br></pre></td></tr></table></figure>

<p>上面错误是数据库没有启动，我不知道如何启动，我重启了服务器，然后好球了。😆<br><a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/2052#note_1667899" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab-ce/issues/2052#note_1667899</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NameError: uninitialized constant Devise::Async</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Processing by RootController#index as HTML</span><br><span class="line">Completed 401 Unauthorized in 17ms (ActiveRecord: 2.7ms)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/log/gitlab/nginx/gitlab_access.log &lt;==</span><br><span class="line">114.55.148.71 - - [04/Jan/2017:17:20:24 +0800] &quot;GET /favicon.ico HTTP/1.0&quot; 502 2662 &quot;http://git.xxxxx.cn/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://packages.gitlab.com/gitlab/gitlab-ce" target="_blank" rel="noopener">gitlab/gitlab-ce</a></li>
<li><a href="https://www.gitlab.cc/downloads" target="_blank" rel="noopener">官网下载</a></li>
<li><a href="https://doc.gitlab.cc/ce/install/requirements.html" target="_blank" rel="noopener">官网安装说明</a></li>
<li><a href="https://www.gitlab.cc/features/#enterprise" target="_blank" rel="noopener">开源版本和企业版本对比</a></li>
<li><a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/8.14-to-8.15.md" target="_blank" rel="noopener">官方升级Gitlab教程</a></li>
<li><a href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/install/centos" target="_blank" rel="noopener">官方Centos安装Gitlab教程</a></li>
<li><a href="http://opjasee.com/2016/01/28/gitlab-upgrade.html" target="_blank" rel="noopener">Gitlab升级记录</a></li>
<li><a href="http://www.yuzhewo.com/2015/11/03/%E4%BF%AE%E6%94%B9gitlab%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89nginx%E6%9C%8D%E5%8A%A1%E5%8F%8A502%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" target="_blank" rel="noopener">修改gitlab使用现有nginx服务及502问题解决</a></li>
<li><a href="http://blog.csdn.net/wangxicoding/article/details/43738137" target="_blank" rel="noopener">我所遇到的GitLab 502问题的解决</a></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="https://dirsky.github.io/2015/08/26/os-linux-CentOS7安装配置vsftp搭建FTP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frank">
      <meta itemprop="description" content="优秀是一种习惯">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="徐先生的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2015/08/26/os-linux-CentOS7安装配置vsftp搭建FTP/" class="post-title-link" itemprop="url">CentOS7安装配置vsftp搭建FTP</a>
          
        </h1>

        <div class="post-meta">

		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2015-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-26T00:00:00+08:00">2015-08-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-09 10:00:27" itemprop="dateModified" datetime="2021-08-09T10:00:27+08:00">2021-08-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2015/08/26/os-linux-CentOS7安装配置vsftp搭建FTP/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2015/08/26/os-linux-CentOS7安装配置vsftp搭建FTP/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>7.5k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>7 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>安装配置vsftpd做FTP服务，我们的项目应用使用git管理进行迭代，公共文件软件存储使用开源网盘Seafile来管理，基本够用。想不到FTP的使用的场景，感觉它好像老去了，虽然现在基本没有用到这个工具，刚好公司公司刷一个硬件需要使用FTP来配置下载文件，于是研究使用了一下，记录了一下使用过程。😀</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在安装前查看是否已安装vsftpd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看是否已安装 方法一</span></span><br><span class="line">[root@localhost ~]# rpm -q vsftpd</span><br><span class="line">vsftpd-3.0.2-21.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否已安装 方法二</span></span><br><span class="line">[root@localhost ~]# vsftpd -v</span><br><span class="line">vsftpd: version 3.0.2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 vsftpd</span></span><br><span class="line">[root@localhost ~]# yum -y install vsftpd</span><br></pre></td></tr></table></figure>

<h2 id="查看位置"><a href="#查看位置" class="headerlink" title="查看位置"></a>查看位置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# whereis vsftpd</span><br><span class="line">vsftpd: /usr/sbin/vsftpd /etc/vsftpd /usr/share/man/man8/vsftpd.8.gz</span><br></pre></td></tr></table></figure>

<h2 id="启动vsftpd服务"><a href="#启动vsftpd服务" class="headerlink" title="启动vsftpd服务"></a>启动vsftpd服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start vsftpd.service</span><br></pre></td></tr></table></figure>

<h2 id="关闭firewall和SELinux"><a href="#关闭firewall和SELinux" class="headerlink" title="关闭firewall和SELinux"></a>关闭firewall和SELinux</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0   # 设置SELinux 成为permissive模式  （关闭SELinux）</span><br><span class="line">setenforce 1   # 设置SELinux 成为enforcing模式   （开启SELinux）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者修改配置</span></span><br><span class="line">vi /etc/selinux/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> SELINUX=enforcing</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释掉</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SELINUXTYPE=targeted</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注释掉</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加</span></span><br><span class="line">:wq! #保存退出</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<p>或者设置SELinux</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">getsebool -a | grep ftp</span><br><span class="line">setsebool -P ftpd_full_access on</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line"><span class="meta">#</span><span class="bash">停止firewall</span></span><br><span class="line">systemctl disable firewalld.service</span><br><span class="line"><span class="meta">#</span><span class="bash">禁止firewall开机启动</span></span><br></pre></td></tr></table></figure>

<p>如果你不愿意关闭防火墙，需要防火墙添加FTP服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=public --add-service=ftp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>配置文件<code>/etc/vsftpd/vsftpd.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">anonymous_enable=NO        # 不允许匿名访问，禁用匿名登录</span><br><span class="line">chroot_local_user=YES      # 启用限定用户在其主目录下</span><br><span class="line">use_localtime=YES          # 使用本地时(自行添加)</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">local_enable=YES           # 允许使用本地帐户进行FTP用户登录验证</span><br><span class="line">allow_writeable_chroot=YES # 如果启用了限定用户在其主目录下需要添加这个配置，解决报错 500 OOPS: vsftpd: refusing to run with writable root inside chroot()</span><br><span class="line">xferlog_enable=YES         # 启用上传和下载的日志功能，默认开启。</span><br><span class="line">local_umask=022            # 设置本地用户默认文件掩码022</span><br><span class="line"><span class="meta">#</span><span class="bash"> FTP上本地的文件权限，默认是077，不过vsftpd安装后的配置文件里默认是022</span></span><br></pre></td></tr></table></figure>

<p>虚拟用户高级参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">当virtual_use_local_privs=YES 时，虚拟用户和本地用户有相同的权限；</span><br><span class="line">当virtual_use_local_privs=NO  时，虚拟用户和匿名用户有相同的权限，默认是NO。</span><br><span class="line">当virtual_use_local_privs=YES，write_enable=YES时，虚拟用户具有写权限（上传、下载、删除、重命名）。</span><br><span class="line">当virtual_use_local_privs=NO，write_enable=YES，anon_world_readable_only=YES，</span><br><span class="line">anon_upload_enable=YES时，虚拟用户不能浏览目录，只能上传文件，无其他权限。</span><br><span class="line">当virtual_use_local_privs=NO，write_enable=YES，anon_world_readable_only=NO，</span><br><span class="line">anon_upload_enable=NO时，虚拟用户只能下载文件，无其他权限。</span><br><span class="line">当virtual_use_local_privs=NO，write_enable=YES，anon_world_readable_only=NO，</span><br><span class="line">anon_upload_enable=YES时，虚拟用户只能上传和下载文件，无其他权限。</span><br><span class="line">当virtual_use_local_privs=NO，write_enable=YES，anon_world_readable_only=NO，</span><br><span class="line">anon_mkdir_write_enable=YES时，虚拟用户只能下载文件和创建文件夹，无其他权限。</span><br><span class="line">当virtual_use_local_privs=NO，write_enable=YES，anon_world_readable_only=NO，</span><br><span class="line">anon_other_write_enable=YES时，虚拟用户只能下载、删除和重命名文件，无其他权限。</span><br></pre></td></tr></table></figure>

<h2 id="匿名登录"><a href="#匿名登录" class="headerlink" title="匿名登录"></a>匿名登录</h2><p>安装完默认情况下是开启匿名登录的，对应的是 <code>/var/ftp</code> 目录，这时只要服务启动了，就可以直接连上FTP了。默认用户名是<code>ftp</code>，密码是空的。如果你在配置里面配置了<code>anonymous_enable=NO</code>，匿名就无法登录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ftp 192.168.188.114</span></span><br><span class="line"></span><br><span class="line">Connected to 192.168.188.114.</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.188.114:kennywang): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ls</span></span><br><span class="line">229 Entering Extended Passive Mode (|||47867|).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0              12 Jan 18 06:31 README.md</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05 19:43 pub</span><br><span class="line">226 Directory send OK.</span><br></pre></td></tr></table></figure>

<h2 id="多用户配置"><a href="#多用户配置" class="headerlink" title="多用户配置"></a>多用户配置</h2><p>多用户配置需要自己手工添加配置，下面内容到vsftpd.conf末尾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line"></span><br><span class="line">use_localtime=YES          # 使用本地时(自行添加)</span><br><span class="line">listen_port=21</span><br><span class="line">chroot_local_user=YES      # 启用限定用户在其主目录下</span><br><span class="line">idle_session_timeout=300</span><br><span class="line"></span><br><span class="line">data_connection_timeout=120  # 数据连接超时时间</span><br><span class="line">guest_enable=YES             # 设定启用虚拟用户功能</span><br><span class="line">guest_username=ftpuser       # 指定虚拟用户的宿主用户 ftpuser（就是我们后面会新建这个用户）</span><br><span class="line"><span class="meta">#</span><span class="bash"> guest_username=www</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果ftp目录是指向网站根目录，用来上传网站程序，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以指定虚拟用户的宿主用户为nginx运行账户www，可以避免很多权限设置问题 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_config_dir=/etc/vsftpd/vuser_conf   # 虚拟用户配置文件目录</span><br><span class="line">virtual_use_local_privs=YES # NO时，虚拟用户和匿名用户有相同的权限，默认是NO</span><br><span class="line"></span><br><span class="line">pasv_min_port=10060         # 被动模式最小端口号10060</span><br><span class="line">pasv_max_port=10090         # 被动模式最大端口号10090</span><br><span class="line"></span><br><span class="line">accept_timeout=5</span><br><span class="line">connect_timeout=1</span><br></pre></td></tr></table></figure>

<h3 id="创建宿主用户"><a href="#创建宿主用户" class="headerlink" title="创建宿主用户"></a>创建宿主用户</h3><p>新建系统用户ftpuser，用户目录为<code>/home/vsftpd</code>, 用户登录终端设为/bin/false(即使之不能登录系统)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 方法一</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建用户 ftpuser 指定 `/home/vsftpd` 目录</span></span><br><span class="line">useradd -g root -M -d /home/vsftpd -s /sbin/nologin ftpuser</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置用户 ftpuser 的密码</span></span><br><span class="line">passwd ftpuser</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把 /home/vsftpd 的所有权给ftpuser.root</span></span><br><span class="line">chown -R ftpuser.root /home/vsftpd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法二</span></span><br><span class="line">useradd ftpuser -d /home/vsftpd -s /bin/false</span><br><span class="line">chown ftpuser:ftpuser /home/vsftpd -R </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果虚拟用户的宿主用户为www，需要这样设置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> www目录是你应用的目录</span></span><br><span class="line">chown www:www /home/www -R</span><br></pre></td></tr></table></figure>

<p>删除用户 <code>userdel ftpuser</code></p>
<h3 id="建立虚拟用户文件"><a href="#建立虚拟用户文件" class="headerlink" title="建立虚拟用户文件"></a>建立虚拟用户文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">touch /etc/vsftpd/vuser_passwd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑虚拟用户名单文件：（</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一行账号，第二行密码，注意：不能使用root做用户名，系统保留）</span></span><br><span class="line">vi /etc/vsftpd/vuser_passwd </span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑内容，下面是 vuser_passwd 内容</span></span><br><span class="line">wcj</span><br><span class="line">123456</span><br><span class="line">hss</span><br><span class="line">123456</span><br><span class="line"><span class="meta">#</span><span class="bash">保存退出</span></span><br></pre></td></tr></table></figure>

<h3 id="生成虚拟用户数据文件"><a href="#生成虚拟用户数据文件" class="headerlink" title="生成虚拟用户数据文件"></a>生成虚拟用户数据文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db_load -T -t hash -f /etc/vsftpd/vuser_passwd /etc/vsftpd/vuser_passwd.db</span><br><span class="line">chmod 600 /etc/vsftpd/vuser_passwd.db</span><br></pre></td></tr></table></figure>

<h3 id="创建用户配置"><a href="#创建用户配置" class="headerlink" title="创建用户配置"></a>创建用户配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/vsftpd/vuser_conf  # 建立虚拟用户个人vsftp的配置文件</span><br><span class="line">cd /etc/vsftpd/vuser_conf     # 进入目录</span><br><span class="line">touch hss wcj                 # 这里创建两个虚拟用户配置文件</span><br></pre></td></tr></table></figure>

<p>每一个文件配置文件都差不多，只是参数<code>local_root</code>不一样。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">local_root=/home/vsftpd/hss   # 用户 hss 配置目录，这个地方不一样</span><br><span class="line">write_enable=YES              # 允许本地用户对FTP服务器文件具有写权限</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES        # 允许匿名用户上传文件(须将全局的write_enable=YES,默认YES)</span><br><span class="line">anon_mkdir_write_enable=YES   # 允许匿名用户创建目录</span><br><span class="line">anon_other_write_enable=YES   # 允许匿名用户删除和重命名权限(自行添加)</span><br></pre></td></tr></table></figure>

<h3 id="创建用户目录"><a href="#创建用户目录" class="headerlink" title="创建用户目录"></a>创建用户目录</h3><p>每个用户目录文件夹是有root用户创建的，也就是上面<code>local_root</code>配置目录，其权限应设置为755。因为权限的问题在该文件夹内无法直接上传文件。而如果设置为777则无法访问，这是由于vsftpd的安全性设置。解决上传问题的方法是在local_root文件夹内新建一个upload的文件夹，权限设置为777，可将文件上传到该文件夹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/vsftpd/hss     # 每个用户对于一个目录，创建两个目录“hss”、“wcj”</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面是目录结构</span></span><br><span class="line">/home/vsftpd</span><br><span class="line">      ├── hss</span><br><span class="line">      │   ├── filename.md</span><br><span class="line">      │   └── upload</span><br><span class="line">      └── wcj</span><br><span class="line">          └── filename.md</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 赋予其权限</span></span><br><span class="line">chmod -R 777 /var/vsftpd/hss/upload/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在/var/ftp下新建一个目录来实现匿名用户上传</span></span><br><span class="line">mkdir /var/ftp/upload</span><br></pre></td></tr></table></figure>

<p>vsftpd中几种用户的区分：</p>
<p><strong>本地用户</strong>：用户在FTP服务器拥有账号，且该账号为本地用户的账号，可以通过自己的账号和口令进行授权登录，登录目录为自己的home目录<code>$HOME</code><br><strong>虚拟用户</strong>：用户在FTP服务器上拥有账号，但该账号只能用于文件传输服务。登录目录为某一特定的目录，通常可以上传和下载<br><strong>匿名用户</strong>：用户在FTP服务器上没有账号，登录目录为/var/ftp  </p>
<h3 id="最后重启vsftpd服务器"><a href="#最后重启vsftpd服务器" class="headerlink" title="最后重启vsftpd服务器"></a>最后重启vsftpd服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd.service</span><br></pre></td></tr></table></figure>

<h2 id="服务运维"><a href="#服务运维" class="headerlink" title="服务运维"></a>服务运维</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd.service  # 重启服务</span><br><span class="line">systemctl start vsftpd.service    # 启动服务</span><br><span class="line">systemctl status vsftpd.service   # 服务状态查看</span><br></pre></td></tr></table></figure>

<h2 id="FTP命令"><a href="#FTP命令" class="headerlink" title="FTP命令"></a>FTP命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ascii  <span class="comment"># 设定以ASCII方式传送文件(缺省值) </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> bell   <span class="comment"># 每完成一次文件传送,报警提示. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> binary <span class="comment"># 设定以二进制方式传送文件. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="built_in">bye</span>    <span class="comment"># 终止主机FTP进程,并退出FTP管理方式. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="keyword">case</span> <span class="comment"># 当为ON时,用MGET命令拷贝的文件名到本地机器中,全部转换为小写字母. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="built_in">cd</span>     <span class="comment"># 同UNIX的CD命令. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> cdup   <span class="comment"># 返回上一级目录. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> chmod  <span class="comment"># 改变远端主机的文件权限. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> close  <span class="comment"># 终止远端的FTP进程,返回到FTP命令状态, 所有的宏定义都被删除. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> delete <span class="comment"># 删除远端主机中的文件. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> dir [remote-directory] [<span class="built_in">local</span>-file] <span class="comment"># 列出当前远端主机目录中的文件.如果有本地文件,就将结果写至本地文件. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> get [remote-file] [<span class="built_in">local</span>-file] <span class="comment"># 从远端主机中传送至本地主机中. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="built_in">help</span> [<span class="built_in">command</span>] <span class="comment"># 输出命令的解释. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> lcd <span class="comment"># 改变当前本地主机的工作目录,如果缺省,就转到当前用户的HOME目录. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ls [remote-directory] [<span class="built_in">local</span>-file] <span class="comment"># 同DIR. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> macdef                 <span class="comment"># 定义宏命令. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> mdelete [remote-files] <span class="comment"># 删除一批文件. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> mget [remote-files]    <span class="comment"># 从远端主机接收一批文件至本地主机. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> mkdir directory-name   <span class="comment"># 在远端主机中建立目录. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> mput <span class="built_in">local</span>-files <span class="comment"># 将本地主机中一批文件传送至远端主机. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> open host [port] <span class="comment"># 重新建立一个新的连接. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> prompt           <span class="comment"># 交互提示模式. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> put <span class="built_in">local</span>-file [remote-file] <span class="comment"># 将本地一个文件传送至远端主机中. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> <span class="built_in">pwd</span>  <span class="comment"># 列出当前远端主机目录. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> quit <span class="comment"># 同BYE. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> recv remote-file [<span class="built_in">local</span>-file] <span class="comment"># 同GET. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> rename [from] [to]     <span class="comment"># 改变远端主机中的文件名. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> rmdir directory-name   <span class="comment"># 删除远端主机中的目录. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> send <span class="built_in">local</span>-file [remote-file] <span class="comment"># 同PUT. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> status   <span class="comment"># 显示当前FTP的状态. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> system   <span class="comment"># 显示远端主机系统类型. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> user user-name [password] [account] <span class="comment"># 重新以别的用户名登录远端主机. </span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ? [<span class="built_in">command</span>] <span class="comment"># 同HELP. [command]指定需要帮助的命令名称。如果没有指定 command，ftp 将显示全部命令的列表。</span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> ! <span class="comment"># 从 ftp 子系统退出到外壳。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="关闭FTP连接"><a href="#关闭FTP连接" class="headerlink" title="关闭FTP连接"></a>关闭FTP连接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bye</span><br><span class="line">exit</span><br><span class="line">quit</span><br></pre></td></tr></table></figure>

<h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> get readme.txt <span class="comment"># 下载 readme.txt 文件</span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> mget *.txt     <span class="comment"># 下载</span></span></span><br></pre></td></tr></table></figure>

<h3 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> put /path/readme.txt <span class="comment"># 上传 readme.txt 文件</span></span></span><br><span class="line"><span class="meta">ftp&gt;</span><span class="bash"> mput *.txt           <span class="comment"># 可以上传多个文件</span></span></span><br></pre></td></tr></table></figure>

<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><ul>
<li>230 - 登录成功</li>
<li>200 - 命令执行成功</li>
<li>150 - 文件状态正常，开启数据连接端口</li>
<li>250 - 目录切换操作完成</li>
<li>226 - 关闭数据连接端口，请求的文件操作成功</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://hx100.blog.51cto.com/44326/383143/" target="_blank" rel="noopener">Vsftpd虚拟用户的配置</a></li>
<li><a href="http://www.cnblogs.com/flandre/p/6051532.html" target="_blank" rel="noopener">CentOS7安装和配置FTP</a></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="https://dirsky.github.io/2015/08/26/os-linux-CentOS7更换yum软件镜像源/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Frank">
      <meta itemprop="description" content="优秀是一种习惯">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="徐先生的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2015/08/26/os-linux-CentOS7更换yum软件镜像源/" class="post-title-link" itemprop="url">CentOS7系统更换软件安装源</a>
          
        </h1>

        <div class="post-meta">

		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2015-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-26T00:00:00+08:00">2015-08-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-09 10:00:27" itemprop="dateModified" datetime="2021-08-09T10:00:27+08:00">2021-08-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2015/08/26/os-linux-CentOS7更换yum软件镜像源/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2015/08/26/os-linux-CentOS7更换yum软件镜像源/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>1.6k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>1 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>阿里云Linux安装镜像源地址：<a href="http://mirrors.aliyun.com/" target="_blank" rel="noopener">http://mirrors.aliyun.com/</a> 。</p>
<p>第一步：备份你的原镜像文件，以免出错后可以恢复。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/yum.repos.d/CentOS-Base.repo&#123;,.backup&#125;</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></table></figure>

<p>第二步：下载新的CentOS-Base.repo 到/etc/yum.repos.d/</p>
<p>如果 wget 没有安装，运行下面命令安装 wget 软件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum update --skip-broken</span><br><span class="line">yum -y install wget</span><br></pre></td></tr></table></figure>

<p>安装完成更新下载源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 5</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</span><br><span class="line"><span class="comment"># CentOS 6</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line"><span class="comment"># CentOS 7</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>

<p>第三步：运行yum makecache生成缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

<p>yum 安装报错 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File <span class="string">"/usr/bin/yum"</span>, line 30 except KeyboardInterrupt, e:</span><br></pre></td></tr></table></figure>

<p>解决：修改文件<code>/usr/bin/yum</code>、<code>/usr/libexec/urlgrabber-ext-down</code>头中相应python为<code>#!/usr/bin/python2.7</code></p>
<h1 id="163官方说明："><a href="#163官方说明：" class="headerlink" title="163官方说明："></a>163官方说明：</h1><p><a href="http://mirrors.163.com/" target="_blank" rel="noopener">http://mirrors.163.com/</a><br><a href="http://mirrors.163.com/.help/centos.html" target="_blank" rel="noopener">http://mirrors.163.com/.help/centos.html</a>  </p>
<h1 id="中国开源镜像站点"><a href="#中国开源镜像站点" class="headerlink" title="中国开源镜像站点"></a>中国开源镜像站点</h1><ul>
<li>阿里云开源镜像站：<a href="http://mirrors.aliyun.com/" target="_blank" rel="noopener">http://mirrors.aliyun.com/</a></li>
<li>网易开源镜像站：<a href="http://mirrors.163.com/" target="_blank" rel="noopener">http://mirrors.163.com/</a></li>
<li>搜狐开源镜像站：<a href="http://mirrors.sohu.com/" target="_blank" rel="noopener">http://mirrors.sohu.com/</a></li>
<li>北京交通大学：<a href="http://mirror.bjtu.edu.cn/cn/" target="_blank" rel="noopener">http://mirror.bjtu.edu.cn/cn/</a> &lt;教育网荐&gt;</li>
<li>兰州大学：<a href="http://mirror.lzu.edu.cn/" target="_blank" rel="noopener">http://mirror.lzu.edu.cn/</a> &lt;西北高校FTP搜索引擎&gt;</li>
<li>厦门大学：<a href="http://mirrors.xmu.edu.cn/" target="_blank" rel="noopener">http://mirrors.xmu.edu.cn/</a></li>
<li>上海交通大学：<a href="http://ftp.sjtu.edu.cn/" target="_blank" rel="noopener">http://ftp.sjtu.edu.cn/</a></li>
<li>清华大学：<a href="http://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener">http://mirrors.tuna.tsinghua.edu.cn/</a><ul>
<li><a href="http://mirrors.6.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener">http://mirrors.6.tuna.tsinghua.edu.cn/</a></li>
<li><a href="http://mirrors.4.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener">http://mirrors.4.tuna.tsinghua.edu.cn/</a></li>
</ul>
</li>
<li>天津大学：<a href="http://mirror.tju.edu.cn/" target="_blank" rel="noopener">http://mirror.tju.edu.cn/</a></li>
<li>中国科学技术大学：<a href="http://mirrors.ustc.edu.cn/" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/</a> <ul>
<li><a href="http://mirrors4.ustc.edu.cn/" target="_blank" rel="noopener">http://mirrors4.ustc.edu.cn/</a> &lt;教育网、电信&gt;</li>
<li><a href="http://mirrors6.ustc.edu.cn/" target="_blank" rel="noopener">http://mirrors6.ustc.edu.cn/</a> <ipv6 only></ipv6></li>
</ul>
</li>
<li>西南大学：<a href="http://linux.swu.edu.cn/swudownload/" target="_blank" rel="noopener">http://linux.swu.edu.cn/swudownload/</a></li>
<li>泰安移动：<a href="http://mirrors.ta139.com/" target="_blank" rel="noopener">http://mirrors.ta139.com/</a></li>
<li>东北大学：<a href="http://mirror.neu.edu.cn/" target="_blank" rel="noopener">http://mirror.neu.edu.cn/</a></li>
<li>浙江大学：<a href="http://mirrors.zju.edu.cn/" target="_blank" rel="noopener">http://mirrors.zju.edu.cn/</a></li>
<li>东软信息学院：<a href="http://mirrors.neusoft.edu.cn/" target="_blank" rel="noopener">http://mirrors.neusoft.edu.cn/</a></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/uploads/avatar.gif"
      alt="Frank">
  <p class="site-author-name" itemprop="name">Frank</p>
  <div class="site-description" itemprop="description">优秀是一种习惯</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/dirsky" title="GitHub &rarr; https://github.com/dirsky" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:gzxu@vip.qq.com" title="E-Mail &rarr; mailto:gzxu@vip.qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://weibo.com/cccsky" title="Weibo &rarr; https://weibo.com/cccsky" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://dirsky.github.io/docsify/#/" title="CV &rarr; https://dirsky.github.io/docsify/#/"><i class="fa fa-fw fa-twitter"></i>CV</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2008 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frank</span>
</div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5d68acfe0fc14e23" async="async"></script>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  


    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest-nomobile.min.js"></script>
  <script src="/lib/anime.min.js?v=3.1.0"></script>
<script src="/js/utils.js?v=7.3.0"></script>
<script src="/js/schemes/pisces.js?v=7.3.0"></script>

<script src="/js/next-boot.js?v=7.3.0"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>





  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id: 20638,
      el: 'wpac-rating',
      color: 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>



  <script src="/js/local-search.js?v=7.3.0"></script>














  

  

  


<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'zwli8bHgrjbtCiAH23o81imX-gzGzoHsz',
    appKey: 'v3rufApMsIhhwFOR45jn5abL',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname
  });
}, window.Valine);
</script>

</body>
</html>